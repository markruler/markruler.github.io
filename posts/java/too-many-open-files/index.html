<!DOCTYPE html>
<html lang="ko"><head>
  
  <title>Too many open files - 임창수 블로그</title>
  
  
  
  
  
  <meta theme="Hugo Theme Diary(MIT) by Rise Ported from Makito's Journal(MIT).">
  <meta charset="utf-8">
  <meta name="X-UA-Compatible" content="IE=edge">
  <meta name="google-site-verification" content="">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="telephone=no" name="format-detection">
  <meta name="description" content="소켓 &#39;파일&#39;을 몰랐을 때의 위험">
  <meta name="renderer" content="webkit">
  <meta name="theme-color" content="#ffffff">

  
  
  <meta property="og:title" content="Too many open files" />
<meta property="og:description" content="소켓 &#39;파일&#39;을 몰랐을 때의 위험" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://markruler.github.io/posts/java/too-many-open-files/" /><meta property="og:image" content="https://markruler.github.io/images/java/too-many-open-files/swimming-pool-lane-pattern-stable-diffusion.jpg" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-20T21:58:00+09:00" />
<meta property="article:modified_time" content="2023-03-20T21:58:00+09:00" /><meta property="og:site_name" content="임창수 블로그" />


  

  
  
  <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://markruler.github.io/images/java/too-many-open-files/swimming-pool-lane-pattern-stable-diffusion.jpg"/>

<meta name="twitter:title" content="Too many open files"/>
<meta name="twitter:description" content="소켓 &#39;파일&#39;을 몰랐을 때의 위험"/>

  

  
  <meta name="google-site-verification" content="60VmMXH5SqMxrPFmaJ27RuE-pn2Yg7hw1BtEkXLmOwc" />
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FFMDWZ27TN"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-FFMDWZ27TN');
  </script>

  
  

  <script src="/vendor/js/jquery.min.js" ></script>
  <script src="/vendor/js/popper.min.js" ></script>
  <script src="/vendor/js/bootstrap.min.js" ></script>
  <script src="/vendor/js/smooth-scroll.polyfills.min.js" ></script>
  <link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">
  <script src="/vendor/js/vue.min.js" ></script>

  

  
  <link rel="icon" href="https://markruler.github.io/images/favicon.ico">
  
  

  
  
  
  <link rel="stylesheet" href="https://markruler.github.io/scss/dark-mode.min.4c4033ff4494b2f0a0c5e7c899105f5abe76b2f05e54a45b5044a3bf6016c74c.css" integrity="sha256-TEAz/0SUsvCgxefImRBfWr52svBeVKRbUESjv2AWx0w=" media="screen">
  

  <script src="https://markruler.github.io//js/loadCSS.js"></script>
  <script>
    loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons");
  </script>

  

  
  
  <script src="https://markruler.github.io//js/toc.js"></script>
  
  

  

  

  

  

</head>
<body>
  <div id="app"><div ref="sideContainer" class="side-container">

  <a class="a-block nav-head false" href="https://markruler.github.io/">

  <div class="nav-title">
    Im Changsu
  </div>
  
    <div class="nav-subtitle">
      What, Why, How.
    </div>
  
  </a>
  <div class="nav-link-list">
    
    
    
    
    
    
    
    <a class="a-block nav-link-item false" href="/about">
      About
    </a>
    
    
    
    
    
    
    
    
    
    <a class="a-block nav-link-item active" href="/posts">
      Posts
    </a>
    
    
    
    
    
    
    
    <a class="a-block nav-link-item false" href="/categories">
      Categories
    </a>
    
    
    
    
    
    
    
    <a class="a-block nav-link-item false" href="/tags">
      Tags
    </a>
    
    
    
    
    
    
    
    <a class="a-block nav-link-item false" href="/index.xml">
      RSS Feed
    </a>
    
    
  </div>

  <div class="nav-footer">
    


&copy;
	
	Im Changsu 2020 - 2023
	

  </div>

</div><div ref="extraContainer" class="extra-container">
    
    
    
    <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- TOC -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%ec%a6%9d%ec%83%81" onclick="onNavClick(`#증상-nav`)" id="증상-nav">
									증상
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%eb%b6%84%ec%84%9d" onclick="onNavClick(`#분석-nav`)" id="분석-nav">
									분석
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#too-many-open-files" onclick="onNavClick(`#too-many-open-files-nav`)" id="too-many-open-files-nav">
									Too many open files
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%ed%8c%8c%ec%9d%bc-%eb%94%94%ec%8a%a4%ed%81%ac%eb%a6%bd%ed%84%b0-file-descriptor" onclick="onNavClick(`#파일-디스크립터-file-descriptor-nav`)" id="파일-디스크립터-file-descriptor-nav">
									파일 디스크립터 (File descriptor)
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%eb%ac%b8%ec%a0%9c-%ec%a0%95%ec%9d%98" onclick="onNavClick(`#문제-정의-nav`)" id="문제-정의-nav">
									문제 정의
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%ed%95%b4%ea%b2%b0" onclick="onNavClick(`#해결-nav`)" id="해결-nav">
									해결
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a class="pagination-action" v-on:click="toggleDarkMode">
            <i class="material-icons pagination-action-icon" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons pagination-action-icon" v-else="isDarkMode">
                brightness_7
            </i>
        </a>
        
        
    </div>
</div>
<div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/about">
                    About
                </a>
                
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/posts">
                    Posts
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    Categories
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    Tags
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS Feed
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- TOC -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%ec%a6%9d%ec%83%81" onclick="onNavClick(`#증상-nav`)" id="증상-nav">
									증상
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%eb%b6%84%ec%84%9d" onclick="onNavClick(`#분석-nav`)" id="분석-nav">
									분석
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#too-many-open-files" onclick="onNavClick(`#too-many-open-files-nav`)" id="too-many-open-files-nav">
									Too many open files
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%ed%8c%8c%ec%9d%bc-%eb%94%94%ec%8a%a4%ed%81%ac%eb%a6%bd%ed%84%b0-file-descriptor" onclick="onNavClick(`#파일-디스크립터-file-descriptor-nav`)" id="파일-디스크립터-file-descriptor-nav">
									파일 디스크립터 (File descriptor)
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%eb%ac%b8%ec%a0%9c-%ec%a0%95%ec%9d%98" onclick="onNavClick(`#문제-정의-nav`)" id="문제-정의-nav">
									문제 정의
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%ed%95%b4%ea%b2%b0" onclick="onNavClick(`#해결-nav`)" id="해결-nav">
									해결
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="https://markruler.github.io/">
            
        </a>
        
        <button type="button" class="nav-darkmode-toggle" v-on:click="toggleDarkMode">
            <i class="material-icons" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons" v-else="isDarkMode">
                brightness_7
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://markruler.github.io/">
        <div class="single-column-header-title"></div>
        
        <div class="single-column-header-subtitle">Im Changsu</div>
        

    </a>
</div>

    <div id="content">
<div ref="streamContainer" class="stream-container">
  <div class="post-list-container post-list-container-shadow">
    <div class="post">
      
      
      
      
      

      <div class="post-head-wrapper"  
        
        style="background-image: url('https://markruler.github.io/images/java/too-many-open-files/swimming-pool-lane-pattern-stable-diffusion.jpg')"  >
        <div class="post-title">
          Too many open files
          
          <div class="post-subtitle">
            소켓 &#39;파일&#39;을 몰랐을 때의 위험
          </div>
          
          <div class="post-meta">
            
            <time itemprop="datePublished">
              2023년 03월 20일 21시 58분
            </time>
            

            
            <i class="material-icons" style="">folder</i>
            <a href="/categories/">[linux]</a>
            &nbsp;
            

            
            <i class="material-icons" style="">label</i>
            
            <a href="/tags/socket">socket</a>
            &nbsp;
            
            <a href="/tags/linux">linux</a>
            &nbsp;
            
            <a href="/tags/file">file</a>
            &nbsp;
            
            
            
          </div>
        </div>
      </div>

      <div class="post-body-wrapper">
        
          <div class="post-body" v-pre>
            
            <blockquote>
<p>커버 이미지 출처: <a href="https://stablediffusionweb.com/">Stable diffusion</a> &ldquo;swimming pool lane pattern&rdquo;</p>
</blockquote>
<h1 id="증상">증상</h1>
<p>Spring framework로 만든 웹 애플리케이션에서 비동기로 HTTP 요청하는 기능을 개발하고 있었다.
요구 사항을 위해 동시에 1,000개 이상의 요청을 보낼 때가 있는데, <code>Too many open files</code> 에러가 발생했다.
작업 PC(Ubuntu 22.04)에서 문제 없이 동작하던 프로그램이
IDC에 위치한 서버(CentOS 7)에서는 <code>OutOfMemoryError</code>가 발생하면서 동작하지 않았다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sh" data-lang="sh">java.lang.OutOfMemoryError: unable to create new native thread
...
java.util.concurrent.ExecutionException: com.markruler.RuntimeException: request error
...
Caused by: java.net.SocketException: Too many open files
</code></pre></div><p><code>SocketException</code>인데 <code>Too many open files</code>? <strong>이게 OOM</strong>?
이해되지 않았다.</p>
<p>문제를 정의하기 위해 먼저 이해부터 해야 했다.</p>
<h1 id="분석">분석</h1>
<h2 id="too-many-open-files">Too many open files</h2>
<p>근본적인 원인이 되는 <code>Too many open files</code>는
프로세스에서 열려 있는 파일 디스크립터의 수가 시스템 제한을 초과하면 발생한다.
로컬 환경(Ubuntu 22.04)에서 먼저 테스트해봤다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sh" data-lang="sh"><span style="color:#6272a4"># 우선 별도의 세션을 연다.</span>
bash
</code></pre></div><p><code>prlimit</code>를 이용해 현재 프로세스의 파일 디스크립터 제한을 확인한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sh" data-lang="sh">prlimit -n
</code></pre></div><p>기본적으로 <strong>4096</strong>이 설정되어 있었다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sh" data-lang="sh">RESOURCE DESCRIPTION              SOFT    HARD UNITS
NOFILE   max number of open files <span style="color:#bd93f9">4096</span> <span style="color:#bd93f9">1048576</span> files
</code></pre></div><p><code>ulimit</code>를 이용해 열 수 있는 파일 디스크립터 수를 제한한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sh" data-lang="sh"><span style="color:#8be9fd;font-style:italic">ulimit</span> -n <span style="color:#bd93f9">0</span>
</code></pre></div><p>그리고 <code>cat</code> 명령어를 실행하면 <code>Too many open files</code>가 발생한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sh" data-lang="sh">cat /etc/os-release
<span style="color:#6272a4"># bash: start_pipeline: pgrp pipe: Too many open files</span>
<span style="color:#6272a4"># ls: error while loading shared libraries: libselinux.so.1: cannot open shared object file: Error 24</span>
</code></pre></div><p>다시 나갔다가 새로운 세션을 연다.
limit을 4로 설정하면 파일 내용이 정상적으로 출력된다.
하지만 에러가 발생한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sh" data-lang="sh"><span style="color:#8be9fd;font-style:italic">ulimit</span> -n <span style="color:#bd93f9">4</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sh" data-lang="sh">cat /etc/os-release
<span style="color:#6272a4"># bash: start_pipeline: pgrp pipe: Too many open files</span>
<span style="color:#6272a4"># PRETTY_NAME=&#34;Ubuntu 22.04.2 LTS&#34;</span>
<span style="color:#6272a4"># ...</span>
</code></pre></div><p>5로 설정하면 에러가 발생하지 않고 정상적으로 출력된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sh" data-lang="sh"><span style="color:#8be9fd;font-style:italic">ulimit</span> -n <span style="color:#bd93f9">5</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sh" data-lang="sh">cat /etc/os-release
<span style="color:#6272a4"># PRETTY_NAME=&#34;Ubuntu 22.04.2 LTS&#34;</span>
<span style="color:#6272a4"># ...</span>
</code></pre></div><p>이유가 무엇일까?</p>
<h2 id="파일-디스크립터-file-descriptor">파일 디스크립터 (File descriptor)</h2>
<p>리눅스에서는 파일을 열면(open) 파일 디스크립터를 반환한다.
반환된 파일 디스크립터는 <code>fdtable</code>의 참조값을 나타내며, 파일을 읽고 쓰는데 사용된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="color:#6272a4">// https://github.com/torvalds/linux/blob/v6.2/include/linux/sched.h#L1088
</span><span style="color:#6272a4"></span>stuct task_struct {
    ...
  <span style="color:#6272a4">/* Filesystem information: */</span>
  <span style="color:#ff79c6">struct</span> fs_struct    <span style="color:#ff79c6">*</span>fs;

  <span style="color:#6272a4">/* Open file information: */</span>
  <span style="color:#ff79c6">struct</span> files_struct <span style="color:#ff79c6">*</span>files;
  ...
};
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="color:#6272a4">// https://github.com/torvalds/linux/blob/v6.2/include/linux/fdtable.h#L49
</span><span style="color:#6272a4"></span><span style="color:#6272a4">/*
</span><span style="color:#6272a4"> * Open file table structure
</span><span style="color:#6272a4"> */</span>
<span style="color:#ff79c6">struct</span> files_struct {
  <span style="color:#ff79c6">struct</span> fdtable __rcu <span style="color:#ff79c6">*</span>fdt;
  ...
  <span style="color:#ff79c6">struct</span> file __rcu <span style="color:#ff79c6">*</span> fd_array[NR_OPEN_DEFAULT];
};
</code></pre></div><p><em>정확히 fd를 어떻게 찾는지는 확인하지 않았다. 나중에 <a href="https://m.blog.naver.com/arcyze/60048807080">이 블로그</a> 참고해서 공부하자.</em></p>
<p><code>fdtable</code>의 0번 fd는 표준 입력(<code>stdin</code>), 1번 fd는 표준 출력(<code>stdout</code>).
2번 fd는 표준 에러(<code>stderr</code>)다.
3번 fd부터 어떤 작업을 수행하는 프로세스가 필요한 파일을 가리킨다.
그래서 <code>ulimit -n 4</code>로 설정하면 정상적으로 <code>cat</code>의 출력이 나오는 것이다.</p>
<p>다시 문제로 돌아가서 그럼 <code>java.net.SocketException: Too many open files</code>는 왜 발생했던 걸까?</p>
<p>Linux에서는 Socket도 파일로 취급한다.
그래서 소켓을 열 때마다 파일 디스크립터가 증가하고,
시스템 제한을 초과하면 <code>Too many open files</code> 에러가 발생하는 것이다.</p>
<p>문제가 발생했던 서버의 시스템 제한을 확인해봤다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sh" data-lang="sh">prlimit -n
</code></pre></div><p>SOFT 값이 1024로 1024개의 파일 디스크립터를 열 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sh" data-lang="sh">RESOURCE DESCRIPTION              SOFT    HARD UNITS
NOFILE   max number of open files <span style="color:#bd93f9">1024</span> <span style="color:#bd93f9">1048576</span> files
</code></pre></div><p>이 제한을 늘리면 문제가 해결될 것 같았다.
그런데 다시 생각해보면 1024 만큼의 요청이 발생할 필요 없는 서버였다.
갑자기 요청이 늘어난 원인이 무엇일까?</p>
<p>혼자가 아닌 함께 개발할 때,
내가 사용하려는 인터페이스가 이미 팀 내에서 통용되어 사용되고 있다면
해당 소스 코드를 복사해서 사용하는 경우가 많았다.
<code>OkHttpClient</code>도 그대로 복사해서 사용했었다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-java" data-lang="java">OkHttpClient client <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> OkHttpClient<span style="color:#ff79c6">();</span>
</code></pre></div><p>하지만 <code>OkHttpClient</code>를 생성자로 생성하면 OkHttp ConnectionPool 스레드가 생성된다.
파일 개수 제한이 4096인 로컬 환경에서 4,000개의 요청을 보내도록 테스트해봤다.</p>
<p><a href="https://markruler.github.io/posts/java/jvm-monitoring/#visualvm">VisualVM</a>을 사용해서 스레드를 확인해봤다.</p>
<p><img src="/images/java/too-many-open-files/visualvm-bad-okhttp-connectionpool.png" alt="visualvm-bad-okhttp-connectionpool"></p>
<p>OkHttp ConnectionPool의 스레드가 4,000개가 채 못 되어 <code>java.net.SocketException: Too many open files</code>이 발생했다.</p>
<h1 id="문제-정의">문제 정의</h1>
<p>실제 문제는 불필요한 스레드가 과다 생성되어 발생한 것이다.
<strong>이 에러가 특히 위험한 이유는 시스템 제한을 초과했기 때문에 동일한 머신에 있는 다른 프로세스에도 영향을 준다는 것이다.</strong></p>
<h1 id="해결">해결</h1>
<p><code>OkHttp ConnectionPool</code>을 재사용하기 위해 Spring Bean으로 등록했다.
<strong>이는 <a href="https://square.github.io/okhttp/4.x/okhttp/okhttp3/-ok-http-client/">공식 문서</a>에도 있는 내용이다.</strong></p>
<blockquote>
<p><strong>OkHttpClients Should Be Shared</strong>
<br>
OkHttp performs best when you create a single OkHttpClient instance
and reuse it for all of your HTTP calls.
This is because each client holds its own connection pool and thread pools.
Reusing connections and threads reduces latency and saves memory.
Conversely, creating a client for each request wastes resources on idle pools.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-java" data-lang="java"><span style="color:#ff79c6">import</span> okhttp3.OkHttpClient<span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">import</span> org.springframework.context.annotation.Bean<span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">import</span> org.springframework.context.annotation.Configuration<span style="color:#ff79c6">;</span>

@Configuration
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">OkHttpConfig</span> <span style="color:#ff79c6">{</span>

    @Bean
    <span style="color:#8be9fd;font-style:italic">public</span> OkHttpClient <span style="color:#50fa7b">okHttpClient</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> OkHttpClient<span style="color:#ff79c6">();</span>
    <span style="color:#ff79c6">}</span>

<span style="color:#ff79c6">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-java" data-lang="java"><span style="color:#ff79c6">import</span> okhttp3.OkHttpClient<span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">import</span> org.springframework.beans.factory.annotation.Autowired<span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">import</span> org.springframework.stereotype.Component<span style="color:#ff79c6">;</span>

@Component
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">MyHttpClient</span> <span style="color:#ff79c6">{</span>

    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> OkHttpClient httpClient<span style="color:#ff79c6">;</span>

    @Autowired
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">MyHttpClient</span><span style="color:#ff79c6">(</span>OkHttpClient httpClient<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">httpClient</span> <span style="color:#ff79c6">=</span> httpClient<span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#6272a4">// ...
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">}</span>
</code></pre></div><p>다시 4,000개의 요청을 보내도록 테스트했다.</p>
<p><img src="/images/java/too-many-open-files/visualvm-okhttpclient-bean.png" alt="visualvm okhttpclient bean"></p>
<p>더 이상 불필요하게 스레드가 늘어나지 않았고,
스레드를 새로 생성할 필요도 없으니 성능 또한 개선되었다.
(평균 10초 → 3초)</p>
<p>시스템 제한 설정을 변경할 필요 없이
<code>Too many open files</code> 에러도 발생하지 않았다.</p>

            
            
            
            
          </div>
        </div>


        <nav class="post-pagination">
          
          <a class="newer-posts">
            다음 글<br>없음
          </a>
          

          
          <a class="older-posts" href="https://markruler.github.io/posts/ci/jenkins-workspace-concurrency/">
            이전 글<br>Jenkins Workspace 동시성 문제
          </a>
          
        </nav>
        
        <div class="post-comment-wrapper">
          
          







        </div>

        
        





<section class="social-share">
  <ul class="share-icons">
    
    
    <li>
      <a href="https://twitter.com/intent/tweet?hashtags=markruler,dev&amp;url=https%3a%2f%2fmarkruler.github.io%2fposts%2fjava%2ftoo-many-open-files%2f&amp;text=Too%20many%20open%20files" target="_blank" rel="noopener" aria-label="Share on Twitter" class="share-btn twitter">
        
<svg xmlns:xlink="http://www.w3.org/1999/xlink" id="twitter" viewBox="0 0 48 48" overflow="hidden">
  <defs></defs>
  <g style="pointer-events:all">
    <title style="pointer-events:inherit">bg</title>
    <circle cx="24" cy="24" fill="#1CB7EB" r="24" style="pointer-events:inherit" id="svg_1"></circle>
    <path d="M36.8,15.4C35.9,15.9 34.8,16.2 33.8,16.3C34.9,15.6 35.7,14.5 36.1,13.2C35.1,13.8 34,14.3 32.7,14.6C31.7,13.5 30.4,12.8 28.9,12.8C26,12.8 23.6,15.3 23.6,18.5C23.6,18.9 23.6,19.4 23.7,19.8C19.3,19.6 15.4,17.3 12.8,13.9C12.3,14.7 12.1,15.7 12.1,16.8C12.1,18.8 13,20.5 14.4,21.5C13.5,21.5 12.7,21.2 12,20.8C12,20.8 12,20.9 12,20.9C12,23.6 13.8,25.9 16.2,26.5C15.8,26.6 15.3,26.7 14.8,26.7C14.5,26.7 14.1,26.7 13.8,26.6C14.5,28.9 16.4,30.5 18.7,30.5C16.9,32 14.6,32.9 12.2,32.9C11.8,32.9 11.4,32.9 10.9,32.8C13.2,34.4 16,35.4 19,35.4C28.7,35.4 34,26.8 34,19.3C34,19.1 34,18.8 34,18.6C35.2,17.6 36.1,16.6 36.8,15.4z" fill="#FFFFFF" style="pointer-events:inherit" id="svg_4"></path>
  </g>
</svg>
        <p>Twitter</p>
      </a>
    </li>
    

    
    
    <li>
      <a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fmarkruler.github.io%2fposts%2fjava%2ftoo-many-open-files%2f" target="_blank" rel="noopener" aria-label="Share on Facebook" class="share-btn facebook">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" enable-background="new 0 0 48 48" id="facebook" version="1.1" viewBox="0 0 48 48" xml:space="preserve">
  <circle cx="24" cy="24" fill="#4E71A8" r="24" />
  <path d="M29.9,19.5h-4v-2.6c0-1,0.7-1.2,1.1-1.2c0.5,0,2.8,0,2.8,0v-4.4l-3.9,0c-4.4,0-5.3,3.3-5.3,5.3v2.9h-2.5V24  h2.5c0,5.8,0,12.7,0,12.7h5.3c0,0,0-7,0-12.7h3.6L29.9,19.5z" fill="#FFFFFF" />
</svg>
        <p>Facebook</p>
        </a>
    </li>
    

    
    
    <li>
      <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fmarkruler.github.io%2fposts%2fjava%2ftoo-many-open-files%2f&amp;source=https%3a%2f%2fmarkruler.github.io%2fposts%2fjava%2ftoo-many-open-files%2f&amp;title=Too%20many%20open%20files&amp;summary=Too%20many%20open%20files" target="_blank" rel="noopener" aria-label="Share on LinkedIn" class="share-btn linkedin">
        <svg xmlns:xlink="http://www.w3.org/1999/xlink" id="linkedin" viewBox="0 0 128 128" overflow="hidden">
  <defs></defs>
  <g style="pointer-events:none">
    <title style="pointer-events:inherit">background</title>
    <rect x="-1" y="-1" width="582" height="402" id="canvas_background" fill="none" style="pointer-events:inherit"></rect>
  </g>
  <g style="pointer-events:all">
    <title style="pointer-events:inherit">Layer 1</title>
    <circle cx="64" cy="64" fill="#0076B4" r="64" id="svg_2" stroke-dasharray="none"></circle>
    <path d="M44.119,95.934L29.184,95.934L29.184,47.93L44.119,47.93L44.119,95.934zM36.656,41.371C31.864,41.371 28,37.495 28,32.718C28,27.943 31.864,24.066 36.656,24.066C41.427,24.066 45.302,27.942 45.302,32.718C45.303,37.495 41.428,41.371 36.656,41.371zM100,95.934L85.081,95.934L85.081,72.59C85.081,67.024 84.984,59.862 77.329,59.862C69.564,59.862 68.381,65.927 68.381,72.192L68.381,95.934L53.479,95.934L53.479,47.93L67.78,47.93L67.78,54.492L67.984,54.492C69.974,50.718 74.841,46.739 82.101,46.739C97.206,46.739 99.998,56.678 99.998,69.607L100,95.934L100,95.934z" fill="#FFFFFF" style="pointer-events:inherit" id="svg_4"></path>
  </g>
</svg>
          <p>LinkedIn</p>
        </a>
    </li>
    

    
    

    
    
    <li>
      <a href="mailto:?subject= - Too%20many%20open%20files.&amp;body=Too%20many%20open%20files%2c%20by%20%0a%ec%86%8c%ec%bc%93%20%27%ed%8c%8c%ec%9d%bc%27%ec%9d%84%20%eb%aa%b0%eb%9e%90%ec%9d%84%20%eb%95%8c%ec%9d%98%20%ec%9c%84%ed%97%98%0a%0ahttps%3a%2f%2fmarkruler.github.io%2fposts%2fjava%2ftoo-many-open-files%2f%0a" target="_blank" class="share-btn email">
        <svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" id="email" overflow="hidden">
  <defs></defs>
  <g style="pointer-events:none">
    <title style="pointer-events:inherit">background</title>
    <rect x="-1" y="-1" width="582" height="402" id="canvas_background" fill="none" style="pointer-events:inherit"></rect>
  </g>
  <g style="pointer-events:all">
    <title style="pointer-events:inherit">Layer 1</title>
    <path d="M16,0C7.163,0 0,7.163 0,16C0,24.836 7.163,32 16,32S32,24.836 32,16C32,7.163 24.837,0 16,0z" fill="#333333" style="pointer-events:inherit" id="svg_2"></path>
    <polygon fill="#FFFFFF" points="6.518,21.815 11.707,15.291 6.518,12.119   " style="pointer-events:inherit" id="svg_4"></polygon>
    <polygon fill="#FFFFFF" points="19.5,15.746 15.989,17.908 12.472,15.758 7.11,22.5 24.867,22.5   " style="pointer-events:inherit" id="svg_5"></polygon>
    <polygon fill="#FFFFFF" points="15.988,16.864 25.482,11.017 25.482,9.5 6.518,9.5 6.518,11.076   " style="pointer-events:inherit" id="svg_6"></polygon>
    <polygon fill="#FFFFFF" points="20.263,15.276 25.482,21.843 25.482,12.062   " style="pointer-events:inherit" id="svg_7"></polygon>
  </g>
</svg>
        <p>Email</p>
      </a>
    </li>
  </ul>
</section>


      </div>
    </div>
  </div>
  
    </div><div id="single-column-footer">


&copy;
	
	Im Changsu 2020 - 2023
	
</div>
  </div>
  <script>
let app;

app = new Vue({
    el: '#app',
    data: {
        scrollY: 0,
        navOpacity: 0,
        isDrawerOpen: false,
        mounted: false,
        isDarkMode: false
    },
    methods: {
            sgn(t, x) {
                let k = 1. / (1. - 2 * t);
                if (x <= t) return 0;
                else if (x >= 1 - t) return 1;
                else {
                    return k * (x - t);
                }
            },
            handleScroll() {
                this.scrollY = window.scrollY;
                this.navOpacity = this.sgn(.0, Math.min(1, Math.max(0, window.scrollY / (this.pageHeadHeight() - this.navBarHeight() * 0.8))));
                const {navBar, navBackground, navTitle, extraContainer, streamContainer} = this.$refs;

                if (this.navOpacity >= 1) {
                    navBackground.style.opacity = 1;
                    navTitle.style.opacity = 1;
                } else {
                    navBackground.style.opacity = 0;
                    navTitle.style.opacity = 0;
                }
            },
            handleResize() {
                const {navBar, navBackground, navTitle, extraContainer, streamContainer} = this.$refs;
                extraContainer.style.left = (streamContainer.offsetWidth - extraContainer.offsetWidth) + 'px';
            },
            navBarHeight() {
                return this.$refs.navBar.offsetHeight;
            },
            pageHeadHeight() {
                return this.$refs.pageHead.offsetHeight;
            },
            toggleDrawer() {
                this.isDrawerOpen = !this.isDrawerOpen;
                document.getElementsByTagName('html')[0].style.overflow = this.isDrawerOpen ? 'hidden' : 'unset';
            },
            closeDrawer() {
                this.isDrawerOpen = false;
                document.getElementsByTagName('html')[0].style.overflow = this.isDrawerOpen ? 'hidden' : 'unset';
            },
            toggleDarkMode() {
                this.isDarkMode = !this.isDarkMode;
                if (this.isDarkMode==true){
                    document.cookie = "night=1;path=/";
                    document.body.classList.add("night");
                } else {
                    document.cookie = "night=0;path=/";
                    document.body.classList.remove("night");
                }
            }
    },
    created() {
        window.addEventListener('scroll', this.handleScroll);
        window.addEventListener('resize', this.handleResize);
        window._nonDesktop = function () {
            let check = false;
            (function (a) {
                if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true;
            })(navigator.userAgent || navigator.vendor || window.opera);
            return check;
        };
        
        var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1");
        if (night==""){
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                
                this.toggleDarkMode();
                
            }
        }else{
            
            if (night=="1") {
                this.toggleDarkMode();
            }
        }
    },
    mounted() {
        this.handleScroll();
        this.handleResize();
        this.mounted = true;

        
    },
    destroyed() {
        window.removeEventListener('scroll', this.handleScroll);
        window.removeEventListener('resize', this.handleResize);
    }
});
</script>

<script src="https://markruler.github.io//js/journal.js"></script>
</body>

</html>