<!DOCTYPE html>
<html lang="ko"><head>

<title>
  
  ì„ì°½ìˆ˜
  
  | Too many open files
  
  
</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="G-FFMDWZ27TN">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=5, user-scalable=5" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="ì†Œì¼“ &#39;íŒŒì¼&#39;ì„ ëª°ëì„ ë•Œì˜ ìœ„í—˜">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">
<link rel="manifest" href="/manifest.json">



<meta property="og:url" content="https://markruler.github.io/posts/java/too-many-open-files/">
  <meta property="og:site_name" content="ì„ì°½ìˆ˜">
  <meta property="og:title" content="Too many open files">
  <meta property="og:description" content="ì†Œì¼“ &#39;íŒŒì¼&#39;ì„ ëª°ëì„ ë•Œì˜ ìœ„í—˜">
  <meta property="og:locale" content="ko_kr">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-03-20T21:58:00+09:00">
    <meta property="article:modified_time" content="2023-03-20T21:58:00+09:00">
    <meta property="article:tag" content="Socket">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="File">
    <meta property="og:image" content="https://markruler.github.io/images/java/too-many-open-files/swimming-pool-lane-pattern-stable-diffusion.jpg">






  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://markruler.github.io/images/java/too-many-open-files/swimming-pool-lane-pattern-stable-diffusion.jpg">
  <meta name="twitter:title" content="Too many open files">
  <meta name="twitter:description" content="ì†Œì¼“ &#39;íŒŒì¼&#39;ì„ ëª°ëì„ ë•Œì˜ ìœ„í—˜">







      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FFMDWZ27TN"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FFMDWZ27TN');
        }
      </script>






  




<link rel="icon" href="https://markruler.github.io/images/favicon.ico">




      <script defer src="/js/toc.js"></script>
    
    
    <link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous" onload="this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"></noscript>

<link rel="preload" as="style" href="/scss/dark-mode.min.52b719ea00393598857c62455f90282e8c6209937ed56f5ca2cf431f99cbc6c3.css" integrity="sha256-UrcZ6gA5NZiFfGJFX5AoLoxiCZN&#43;1W9cos9DH5nLxsM=" media="screen" onload="this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="/scss/dark-mode.min.52b719ea00393598857c62455f90282e8c6209937ed56f5ca2cf431f99cbc6c3.css"></noscript>





















</head>
<body>
    	<div id="app"><div class="single-column-drawer-container" id="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/about">
                    About
                </a>
                
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/posts">
                    Posts
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    Categories
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    Tags
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS Feed
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- ëª©ì°¨ -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%ec%a6%9d%ec%83%81" class="nav-ì¦ìƒ">
									ì¦ìƒ
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%eb%b6%84%ec%84%9d" class="nav-ë¶„ì„">
									ë¶„ì„
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#too-many-open-files" class="nav-too-many-open-files">
									Too many open files
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%ed%8c%8c%ec%9d%bc-%eb%94%94%ec%8a%a4%ed%81%ac%eb%a6%bd%ed%84%b0-file-descriptor" class="nav-íŒŒì¼-ë””ìŠ¤í¬ë¦½í„°-file-descriptor">
									íŒŒì¼ ë””ìŠ¤í¬ë¦½í„° (File descriptor)
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%eb%ac%b8%ec%a0%9c-%ec%a0%95%ec%9d%98" class="nav-ë¬¸ì œ-ì •ì˜">
									ë¬¸ì œ ì •ì˜
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%ed%95%b4%ea%b2%b0" class="nav-í•´ê²°">
									í•´ê²°
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div id="drawer-mask" v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav id="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div id="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            ğŸ“œ
        </button>
        <a id="navTitle" class="navbar-brand" href="https://markruler.github.io/">
            ì„ì°½ìˆ˜
        </a>
        
        <button type="button" class="nav-darkmode-toggle" id="darkModeToggleButton2">
            ğŸŒ™
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" id="pageHead"
    v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <button
        class="read-random-mobile"
        data-target-prefix="/posts">
        Navigate to Random Post
    </button>
    <a href="https://markruler.github.io/">
        <div class="single-column-header-title">ì„ì°½ìˆ˜</div>
        
        <div class="single-column-header-subtitle">What, Why, How.</div>
        

    </a>
</div>

            <div id="content">
                <div id="streamContainer" class="stream-container">

    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            
                
            

            <div class="post-head-wrapper"
                
                    
                    
                    style="background-image: url('https://markruler.github.io/images/java/too-many-open-files/swimming-pool-lane-pattern-stable-diffusion.jpg')"
                    
                
            >
                <div class="post-title">
                    Too many open files
                    
                    <div class="post-subtitle">
                        ì†Œì¼“ &#39;íŒŒì¼&#39;ì„ ëª°ëì„ ë•Œì˜ ìœ„í—˜
                    </div>
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2023-03-20 21:58
                        </time>
                        

                        
                            <a href="/categories/blog">[blog]</a>
                            &nbsp;
                        

                        
                            
                                <a href="/tags/socket">socket</a>
                                &nbsp;
                            
                                <a href="/tags/linux">linux</a>
                                &nbsp;
                            
                                <a href="/tags/file">file</a>
                                &nbsp;
                            
                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <blockquote>
<p>ì»¤ë²„ ì´ë¯¸ì§€ ì¶œì²˜: <a href="https://stablediffusionweb.com/">Stable diffusion</a> &ldquo;swimming pool lane pattern&rdquo;</p>
</blockquote>
<h1 id="ì¦ìƒ">ì¦ìƒ</h1>
<p>Spring frameworkë¡œ ë§Œë“  ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë¹„ë™ê¸°ë¡œ HTTP ìš”ì²­í•˜ëŠ” ê¸°ëŠ¥ì„ ê°œë°œí•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤.
ìš”êµ¬ ì‚¬í•­ì„ ìœ„í•´ ë™ì‹œì— 1,000ê°œ ì´ìƒì˜ ìš”ì²­ì„ ë³´ë‚¼ ë•Œê°€ ìˆëŠ”ë°, <code>Too many open files</code> ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
ì‘ì—… PC(Ubuntu 22.04)ì—ì„œ ë¬¸ì œ ì—†ì´ ë™ì‘í•˜ë˜ í”„ë¡œê·¸ë¨ì´
IDCì— ìœ„ì¹˜í•œ ì„œë²„(CentOS 7)ì—ì„œëŠ” <code>OutOfMemoryError</code>ê°€ ë°œìƒí•˜ë©´ì„œ ë™ì‘í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2;display:grid;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>java.lang.OutOfMemoryError: unable to create new native thread
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>java.util.concurrent.ExecutionException: com.markruler.RuntimeException: request error
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Caused by: java.net.SocketException: Too many open files
</span></span></code></pre></div><p><code>SocketException</code>ì¸ë° <code>Too many open files</code>? <strong>ì´ê²Œ OOM</strong>?
ì´í•´ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
<p>ë¬¸ì œë¥¼ ì •ì˜í•˜ê¸° ìœ„í•´ ë¨¼ì € ì´í•´ë¶€í„° í•´ì•¼ í–ˆìŠµë‹ˆë‹¤.</p>
<h1 id="ë¶„ì„">ë¶„ì„</h1>
<h2 id="too-many-open-files">Too many open files</h2>
<p>ê·¼ë³¸ì ì¸ ì›ì¸ì´ ë˜ëŠ” <code>Too many open files</code>ëŠ”
í”„ë¡œì„¸ìŠ¤ì—ì„œ ì—´ë ¤ ìˆëŠ” íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°ì˜ ìˆ˜ê°€ ì‹œìŠ¤í…œ ì œí•œì„ ì´ˆê³¼í•˜ë©´ ë°œìƒí•©ë‹ˆë‹¤.
ë¡œì»¬ í™˜ê²½(Ubuntu 22.04)ì—ì„œ ë¨¼ì € í…ŒìŠ¤íŠ¸í•´ë´¤ìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2;display:grid;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#0f0"># ìš°ì„  ë³„ë„ì˜ ì„¸ì…˜ì„ ì—°ë‹¤.</span>
</span></span><span style="display:flex;"><span>bash
</span></span></code></pre></div><p><code>prlimit</code>ë¥¼ ì´ìš©í•´ í˜„ì¬ í”„ë¡œì„¸ìŠ¤ì˜ íŒŒì¼ ë””ìŠ¤í¬ë¦½í„° ì œí•œì„ í™•ì¸í•©ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2;display:grid;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>prlimit -n
</span></span></code></pre></div><p>ê¸°ë³¸ì ìœ¼ë¡œ <strong>4096</strong>ì´ ì„¤ì •ë˜ì–´ ìˆì—ˆìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2;display:grid;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>RESOURCE DESCRIPTION              SOFT    HARD UNITS
</span></span><span style="display:flex;"><span>NOFILE   max number of open files <span style="color:#f60">4096</span> <span style="color:#f60">1048576</span> files
</span></span></code></pre></div><p><code>ulimit</code>ë¥¼ ì´ìš©í•´ ì—´ ìˆ˜ ìˆëŠ” íŒŒì¼ ë””ìŠ¤í¬ë¦½í„° ìˆ˜ë¥¼ ì œí•œí•©ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2;display:grid;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ulimit -n <span style="color:#f60">0</span>
</span></span></code></pre></div><p>ê·¸ë¦¬ê³  <code>cat</code> ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ë©´ <code>Too many open files</code>ê°€ ë°œìƒí•©ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2;display:grid;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cat /etc/os-release
</span></span><span style="display:flex;"><span><span style="color:#0f0"># bash: start_pipeline: pgrp pipe: Too many open files</span>
</span></span><span style="display:flex;"><span><span style="color:#0f0"># ls: error while loading shared libraries: libselinux.so.1: cannot open shared object file: Error 24</span>
</span></span></code></pre></div><p>ë‹¤ì‹œ ë‚˜ê°”ë‹¤ê°€ ìƒˆë¡œìš´ ì„¸ì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤.
limitì„ 4ë¡œ ì„¤ì •í•˜ë©´ íŒŒì¼ ë‚´ìš©ì´ ì •ìƒì ìœ¼ë¡œ ì¶œë ¥ë©ë‹ˆë‹¤.
í•˜ì§€ë§Œ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2;display:grid;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ulimit -n <span style="color:#f60">4</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2;display:grid;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cat /etc/os-release
</span></span><span style="display:flex;"><span><span style="color:#0f0"># bash: start_pipeline: pgrp pipe: Too many open files</span>
</span></span><span style="display:flex;"><span><span style="color:#0f0"># PRETTY_NAME=&#34;Ubuntu 22.04.2 LTS&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#0f0"># ...</span>
</span></span></code></pre></div><p>5ë¡œ ì„¤ì •í•˜ë©´ ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•Šê³  ì •ìƒì ìœ¼ë¡œ ì¶œë ¥ë©ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2;display:grid;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ulimit -n <span style="color:#f60">5</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2;display:grid;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cat /etc/os-release
</span></span><span style="display:flex;"><span><span style="color:#0f0"># PRETTY_NAME=&#34;Ubuntu 22.04.2 LTS&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#0f0"># ...</span>
</span></span></code></pre></div><p>ì´ìœ ê°€ ë¬´ì—‡ì¼ê¹Œìš”?</p>
<h2 id="íŒŒì¼-ë””ìŠ¤í¬ë¦½í„°-file-descriptor">íŒŒì¼ ë””ìŠ¤í¬ë¦½í„° (File descriptor)</h2>
<p>ë¦¬ëˆ…ìŠ¤ì—ì„œëŠ” íŒŒì¼ì„ ì—´ë©´(open) íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
ë°˜í™˜ëœ íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°ëŠ” <code>fdtable</code>ì˜ ì°¸ì¡°ê°’ì„ ë‚˜íƒ€ë‚´ë©°, íŒŒì¼ì„ ì½ê³  ì“°ëŠ”ë° ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2;display:grid;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#0f0">// https://github.com/torvalds/linux/blob/v6.2/include/linux/sched.h#L1088
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"></span>stuct task_struct {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>  <span style="color:#0f0">/* Filesystem information: */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f00">struct</span> fs_struct    *fs;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#0f0">/* Open file information: */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f00">struct</span> files_struct *files;
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2;display:grid;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#0f0">// https://github.com/torvalds/linux/blob/v6.2/include/linux/fdtable.h#L49
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"></span><span style="color:#0f0">/*
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"> * Open file table structure
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#f00">struct</span> files_struct {
</span></span><span style="display:flex;"><span>  <span style="color:#f00">struct</span> fdtable __rcu *fdt;
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  <span style="color:#f00">struct</span> file __rcu * fd_array[NR_OPEN_DEFAULT];
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p><em>ì •í™•íˆ fdë¥¼ ì–´ë–»ê²Œ ì°¾ëŠ”ì§€ëŠ” í™•ì¸í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— <a href="https://m.blog.naver.com/arcyze/60048807080">ì´ ë¸”ë¡œê·¸</a>ë¥¼ ì°¸ê³ í•´ì„œ ê³µë¶€í•´ë´ì•¼ê² ìŠµë‹ˆë‹¤.</em></p>
<p><code>fdtable</code>ì˜ 0ë²ˆ fdëŠ” í‘œì¤€ ì…ë ¥(<code>stdin</code>), 1ë²ˆ fdëŠ” í‘œì¤€ ì¶œë ¥(<code>stdout</code>),
2ë²ˆ fdëŠ” í‘œì¤€ ì—ëŸ¬(<code>stderr</code>)ì…ë‹ˆë‹¤.
3ë²ˆ fdë¶€í„° ì–´ë–¤ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ê°€ í•„ìš”í•œ íŒŒì¼ì„ ê°€ë¦¬í‚µë‹ˆë‹¤.
ê·¸ë˜ì„œ <code>ulimit -n 4</code>ë¡œ ì„¤ì •í•˜ë©´ ì •ìƒì ìœ¼ë¡œ <code>cat</code>ì˜ ì¶œë ¥ì´ ë‚˜ì˜¤ëŠ” ê²ƒì…ë‹ˆë‹¤.</p>
<p>ë‹¤ì‹œ ë¬¸ì œë¡œ ëŒì•„ê°€ì„œ ê·¸ëŸ¼ <code>java.net.SocketException: Too many open files</code>ëŠ” ì™œ ë°œìƒí–ˆë˜ ê±¸ê¹Œìš”?</p>
<p>Linuxì—ì„œëŠ” Socketë„ íŒŒì¼ë¡œ ì·¨ê¸‰í•©ë‹ˆë‹¤.
ê·¸ë˜ì„œ ì†Œì¼“ì„ ì—´ ë•Œë§ˆë‹¤ íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°ê°€ ì¦ê°€í•˜ê³ ,
ì‹œìŠ¤í…œ ì œí•œì„ ì´ˆê³¼í•˜ë©´ <code>Too many open files</code> ì—ëŸ¬ê°€ ë°œìƒí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.</p>
<p>ë¬¸ì œê°€ ë°œìƒí–ˆë˜ ì„œë²„ì˜ ì‹œìŠ¤í…œ ì œí•œì„ í™•ì¸í•´ë´¤ìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2;display:grid;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>prlimit -n
</span></span></code></pre></div><p>SOFT ê°’ì´ 1024ë¡œ 1024ê°œì˜ íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°ë¥¼ ì—´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2;display:grid;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>RESOURCE DESCRIPTION              SOFT    HARD UNITS
</span></span><span style="display:flex;"><span>NOFILE   max number of open files <span style="color:#f60">1024</span> <span style="color:#f60">1048576</span> files
</span></span></code></pre></div><p>ì´ ì œí•œì„ ëŠ˜ë¦¬ë©´ ë¬¸ì œê°€ í•´ê²°ë  ê²ƒ ê°™ì•˜ìŠµë‹ˆë‹¤.
ê·¸ëŸ°ë° ë‹¤ì‹œ ìƒê°í•´ë³´ë©´ 1024 ë§Œí¼ì˜ ìš”ì²­ì´ ë°œìƒí•  í•„ìš” ì—†ëŠ” ì„œë²„ì˜€ìŠµë‹ˆë‹¤.
ê°‘ìê¸° ìš”ì²­ì´ ëŠ˜ì–´ë‚œ ì›ì¸ì´ ë¬´ì—‡ì¼ê¹Œìš”?</p>
<p>í˜¼ìê°€ ì•„ë‹Œ í•¨ê»˜ ê°œë°œí•  ë•Œ,
ë‚´ê°€ ì‚¬ìš©í•˜ë ¤ëŠ” ì¸í„°í˜ì´ìŠ¤ê°€ ì´ë¯¸ íŒ€ ë‚´ì—ì„œ í†µìš©ë˜ì–´ ì‚¬ìš©ë˜ê³  ìˆë‹¤ë©´
í•´ë‹¹ ì†ŒìŠ¤ ì½”ë“œë¥¼ ë³µì‚¬í•´ì„œ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ê°€ ë§ì•˜ìŠµë‹ˆë‹¤.
<code>OkHttpClient</code>ë„ ê·¸ëŒ€ë¡œ ë³µì‚¬í•´ì„œ ì‚¬ìš©í–ˆì—ˆìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2;display:grid;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>OkHttpClient client = <span style="color:#f00">new</span> OkHttpClient();
</span></span></code></pre></div><p>í•˜ì§€ë§Œ <code>OkHttpClient</code>ë¥¼ ìƒì„±ìë¡œ ìƒì„±í•˜ë©´ OkHttp ConnectionPool ìŠ¤ë ˆë“œê°€ ìƒì„±ë©ë‹ˆë‹¤.
íŒŒì¼ ê°œìˆ˜ ì œí•œì´ 4096ì¸ ë¡œì»¬ í™˜ê²½ì—ì„œ 4,000ê°œì˜ ìš”ì²­ì„ ë³´ë‚´ë„ë¡ í…ŒìŠ¤íŠ¸ í•´ë´¤ìŠµë‹ˆë‹¤.</p>
<p><a href="https://markruler.github.io/posts/java/jvm-monitoring/#visualvm">VisualVM</a>ì„ ì‚¬ìš©í•´ì„œ ìŠ¤ë ˆë“œë¥¼ í™•ì¸í•´ë´¤ìŠµë‹ˆë‹¤.</p>
<p><img src="/images/java/too-many-open-files/visualvm-bad-okhttp-connectionpool.png" alt="visualvm-bad-okhttp-connectionpool"></p>
<p>OkHttp ConnectionPoolì˜ ìŠ¤ë ˆë“œê°€ 4,000ê°œê°€ ì±„ ëª» ë˜ì–´ <code>java.net.SocketException: Too many open files</code>ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
<h1 id="ë¬¸ì œ-ì •ì˜">ë¬¸ì œ ì •ì˜</h1>
<p>ì‹¤ì œ ë¬¸ì œëŠ” ë¶ˆí•„ìš”í•œ ìŠ¤ë ˆë“œê°€ ê³¼ë‹¤ ìƒì„±ë˜ì–´ ë°œìƒí•œ ê²ƒì…ë‹ˆë‹¤.
<strong>ì´ ì—ëŸ¬ê°€ íŠ¹íˆ ìœ„í—˜í•œ ì´ìœ ëŠ” ì‹œìŠ¤í…œ ì œí•œì„ ì´ˆê³¼í–ˆê¸° ë•Œë¬¸ì— ë™ì¼í•œ ë¨¸ì‹ ì— ìˆëŠ” ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ì—ë„ ì˜í–¥ì„ ì¤€ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.</strong></p>
<h1 id="í•´ê²°">í•´ê²°</h1>
<p><code>OkHttp ConnectionPool</code>ì„ ì¬ì‚¬ìš©í•˜ê¸° ìœ„í•´ Spring Beanìœ¼ë¡œ ë“±ë¡í–ˆìŠµë‹ˆë‹¤.
<strong>ì´ëŠ” <a href="https://square.github.io/okhttp/5.x/okhttp/okhttp3/-ok-http-client/index.html">ê³µì‹ ë¬¸ì„œ</a>ì—ë„ ìˆëŠ” ë‚´ìš©ì…ë‹ˆë‹¤.</strong></p>
<blockquote>
<p><strong>OkHttpClients Should Be Shared</strong>
<br>
OkHttp performs best when you create a single OkHttpClient instance
and reuse it for all of your HTTP calls.
This is because each client holds its own connection pool and thread pools.
Reusing connections and threads reduces latency and saves memory.
Conversely, creating a client for each request wastes resources on idle pools.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2;display:grid;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f00">import</span> okhttp3.OkHttpClient;
</span></span><span style="display:flex;"><span><span style="color:#f00">import</span> org.springframework.context.annotation.Bean;
</span></span><span style="display:flex;"><span><span style="color:#f00">import</span> org.springframework.context.annotation.Configuration;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#f00">public</span> <span style="color:#f00">class</span> OkHttpConfig {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#f00">public</span> OkHttpClient <span style="color:#ff0">okHttpClient</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#f00">return</span> <span style="color:#f00">new</span> OkHttpClient();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2;display:grid;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f00">import</span> okhttp3.OkHttpClient;
</span></span><span style="display:flex;"><span><span style="color:#f00">import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style="display:flex;"><span><span style="color:#f00">import</span> org.springframework.stereotype.Component;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#f00">public</span> <span style="color:#f00">class</span> MyHttpClient {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f00">private</span> <span style="color:#f00">final</span> OkHttpClient httpClient;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#f00">public</span> <span style="color:#ff0">MyHttpClient</span>(OkHttpClient httpClient) {
</span></span><span style="display:flex;"><span>        <span style="color:#f00">this</span>.httpClient = httpClient;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#0f0">// ...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ë‹¤ì‹œ 4,000ê°œì˜ ìš”ì²­ì„ ë³´ë‚´ë„ë¡ í…ŒìŠ¤íŠ¸ í–ˆìŠµë‹ˆë‹¤.</p>
<p><img src="/images/java/too-many-open-files/visualvm-okhttpclient-bean.png" alt="visualvm okhttpclient bean"></p>
<p>ë” ì´ìƒ ë¶ˆí•„ìš”í•˜ê²Œ ìŠ¤ë ˆë“œê°€ ëŠ˜ì–´ë‚˜ì§€ ì•Šì•˜ê³ ,
ìŠ¤ë ˆë“œë¥¼ ìƒˆë¡œ ìƒì„±í•  í•„ìš”ë„ ì—†ìœ¼ë‹ˆ ì„±ëŠ¥ ë˜í•œ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.
(í‰ê·  10ì´ˆ â†’ 3ì´ˆ)</p>
<p>ì‹œìŠ¤í…œ ì œí•œ ì„¤ì •ì„ ë³€ê²½í•  í•„ìš” ì—†ì´ <code>Too many open files</code> ì—ëŸ¬ë„ ë°œìƒí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>

                    
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">ìµœì¢… ìˆ˜ì •: 2023-03-20</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="/posts/db/oracle-dbms-session-diagnosis/">
			ë‹¤ìŒê¸€<br>ì˜¤ë¼í´ DBMS SE2 ì„¸ì…˜ ì‚¬í›„ ì§„ë‹¨
                </a>
                
                
                
                <a class="older-posts" href="/posts/search/elasticsearch-indexing-strategy/">
			ì´ì „ê¸€<br>ì—˜ë¼ìŠ¤í‹±ì„œì¹˜(Elasticsearch)ì™€ ë°ì´í„° ì¸ë±ì‹± ì „ëµ
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                












            </div>

            





<section class="social-share">
  <ul class="share-icons">
    
    
    <li>
      <a href="https://twitter.com/intent/tweet?hashtags=markruler,dev&amp;url=https%3a%2f%2fmarkruler.github.io%2fposts%2fjava%2ftoo-many-open-files%2f&amp;text=Too%20many%20open%20files" target="_blank" rel="noopener" aria-label="Share on Twitter" class="share-btn twitter">
        <svg xmlns:xlink="http://www.w3.org/1999/xlink" id="twitter" viewBox="0 0 48 48" overflow="hidden">
  <defs></defs>
  <g style="pointer-events:all">
    <title style="pointer-events:inherit">bg</title>
    <circle cx="24" cy="24" fill="#1CB7EB" r="24" style="pointer-events:inherit" id="svg_1"></circle>
    <path d="M36.8,15.4C35.9,15.9 34.8,16.2 33.8,16.3C34.9,15.6 35.7,14.5 36.1,13.2C35.1,13.8 34,14.3 32.7,14.6C31.7,13.5 30.4,12.8 28.9,12.8C26,12.8 23.6,15.3 23.6,18.5C23.6,18.9 23.6,19.4 23.7,19.8C19.3,19.6 15.4,17.3 12.8,13.9C12.3,14.7 12.1,15.7 12.1,16.8C12.1,18.8 13,20.5 14.4,21.5C13.5,21.5 12.7,21.2 12,20.8C12,20.8 12,20.9 12,20.9C12,23.6 13.8,25.9 16.2,26.5C15.8,26.6 15.3,26.7 14.8,26.7C14.5,26.7 14.1,26.7 13.8,26.6C14.5,28.9 16.4,30.5 18.7,30.5C16.9,32 14.6,32.9 12.2,32.9C11.8,32.9 11.4,32.9 10.9,32.8C13.2,34.4 16,35.4 19,35.4C28.7,35.4 34,26.8 34,19.3C34,19.1 34,18.8 34,18.6C35.2,17.6 36.1,16.6 36.8,15.4z" fill="#FFFFFF" style="pointer-events:inherit" id="svg_4"></path>
  </g>
</svg>
        <p>Twitter</p>
      </a>
    </li>
    

    
    
    <li>
      <a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fmarkruler.github.io%2fposts%2fjava%2ftoo-many-open-files%2f" target="_blank" rel="noopener" aria-label="Share on Facebook" class="share-btn facebook">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" enable-background="new 0 0 48 48" id="facebook" version="1.1" viewBox="0 0 48 48" xml:space="preserve">
  <circle cx="24" cy="24" fill="#4E71A8" r="24" />
  <path d="M29.9,19.5h-4v-2.6c0-1,0.7-1.2,1.1-1.2c0.5,0,2.8,0,2.8,0v-4.4l-3.9,0c-4.4,0-5.3,3.3-5.3,5.3v2.9h-2.5V24  h2.5c0,5.8,0,12.7,0,12.7h5.3c0,0,0-7,0-12.7h3.6L29.9,19.5z" fill="#FFFFFF" />
</svg>
        <p>Facebook</p>
        </a>
    </li>
    

    
    

    
    

    
    
    <li>
      <a href="mailto:?subject=%ec%9e%84%ec%b0%bd%ec%88%98 - Too%20many%20open%20files.&amp;body=Too%20many%20open%20files%2c%20by%20%ec%9e%84%ec%b0%bd%ec%88%98%0a%ec%86%8c%ec%bc%93%20%27%ed%8c%8c%ec%9d%bc%27%ec%9d%84%20%eb%aa%b0%eb%9e%90%ec%9d%84%20%eb%95%8c%ec%9d%98%20%ec%9c%84%ed%97%98%0a%0ahttps%3a%2f%2fmarkruler.github.io%2fposts%2fjava%2ftoo-many-open-files%2f%0a" target="_blank" class="share-btn email">
        <svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" id="email" overflow="hidden">
  <defs></defs>
  <g style="pointer-events:none">
    <title style="pointer-events:inherit">background</title>
    <rect x="-1" y="-1" width="582" height="402" id="canvas_background" fill="none" style="pointer-events:inherit"></rect>
  </g>
  <g style="pointer-events:all">
    <title style="pointer-events:inherit">Layer 1</title>
    <path d="M16,0C7.163,0 0,7.163 0,16C0,24.836 7.163,32 16,32S32,24.836 32,16C32,7.163 24.837,0 16,0z" fill="#333333" style="pointer-events:inherit" id="svg_2"></path>
    <polygon fill="#FFFFFF" points="6.518,21.815 11.707,15.291 6.518,12.119   " style="pointer-events:inherit" id="svg_4"></polygon>
    <polygon fill="#FFFFFF" points="19.5,15.746 15.989,17.908 12.472,15.758 7.11,22.5 24.867,22.5   " style="pointer-events:inherit" id="svg_5"></polygon>
    <polygon fill="#FFFFFF" points="15.988,16.864 25.482,11.017 25.482,9.5 6.518,9.5 6.518,11.076   " style="pointer-events:inherit" id="svg_6"></polygon>
    <polygon fill="#FFFFFF" points="20.263,15.276 25.482,21.843 25.482,12.062   " style="pointer-events:inherit" id="svg_7"></polygon>
  </g>
</svg>
        <p>Email</p>
      </a>
    </li>
  </ul>
</section>


        </div>
    </div>


                    </div>
            </div><div id="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://markruler.github.io/">
    
        <div class="nav-title">
            ì„ì°½ìˆ˜
        </div>
        
        <div class="nav-subtitle">
            What, Why, How.
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/about">
                About
            </a>
            
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/posts">
                Posts
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                Categories
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                Tags
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSS Feed
            </a>
            
        
        <div
            class="read-random a-block nav-link-item false"
            data-target-prefix="/posts">
            Navigate to Random Post
        </div>
    </div>

    <div class="nav-footer">
        


Hugo Theme <a style="color: #0054B8; text-decoration: underline;" href="https://github.com/amazingrise/hugo-theme-diary">Diary</a>
by <a style="color: #0054B8; text-decoration: underline;" href="https://risehere.net/">Rise</a>
<br>
Ported from <a style="color: #0054B8; text-decoration: underline;" href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s
<a style="color: #0054B8; text-decoration: underline;" href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	Im Changsu | Since 2020
	

    </div>
    
</div><div id="extraContainer" class="extra-container">
    <div class="toc-wrapper">
        

        
        <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- ëª©ì°¨ -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%ec%a6%9d%ec%83%81" class="nav-ì¦ìƒ">
									ì¦ìƒ
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%eb%b6%84%ec%84%9d" class="nav-ë¶„ì„">
									ë¶„ì„
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#too-many-open-files" class="nav-too-many-open-files">
									Too many open files
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%ed%8c%8c%ec%9d%bc-%eb%94%94%ec%8a%a4%ed%81%ac%eb%a6%bd%ed%84%b0-file-descriptor" class="nav-íŒŒì¼-ë””ìŠ¤í¬ë¦½í„°-file-descriptor">
									íŒŒì¼ ë””ìŠ¤í¬ë¦½í„° (File descriptor)
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%eb%ac%b8%ec%a0%9c-%ec%a0%95%ec%9d%98" class="nav-ë¬¸ì œ-ì •ì˜">
									ë¬¸ì œ ì •ì˜
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%ed%95%b4%ea%b2%b0" class="nav-í•´ê²°">
									í•´ê²°
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
        
    </div>
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top"
            :class="{ invisible: scrollY == 0 }">
            ğŸ”
        </a>
        
        <a type="button" class="pagination-action" id="darkModeToggleButton">
            <span class="pagination-action-icon" id="darkModeToggleIcon">
                ğŸŒ™
            </span>
        </a>
        
        
    </div>
</div>

<div id="single-column-footer">


Hugo Theme <a style="color: #0054B8; text-decoration: underline;" href="https://github.com/amazingrise/hugo-theme-diary">Diary</a>
by <a style="color: #0054B8; text-decoration: underline;" href="https://risehere.net/">Rise</a>
<br>
Ported from <a style="color: #0054B8; text-decoration: underline;" href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s
<a style="color: #0054B8; text-decoration: underline;" href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	Im Changsu | Since 2020
	
</div>
            </div>
    
    <script defer src="/js/journal.js"></script><script defer src="/js/read-random.js"></script>

    <script>
        
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('/js/sw.js')
            .then(registration => {
              console.log('Service Worker registered with scope:', registration.scope);
            })
            .catch(error => {
              console.log('Service Worker registration failed:', error);
            });
        }
      </script>
    </body>
</html>
