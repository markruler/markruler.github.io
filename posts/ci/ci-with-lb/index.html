<!DOCTYPE html>
<html lang="ko"><head>
  
  <title>Load Balancer를 활용해서 배포 프로세스를 개선해보자 - 임창수 블로그</title>
  
  
  
  
  
  <meta theme="Hugo Theme Diary(MIT) by Rise Ported from Makito's Journal(MIT).">
  <meta charset="utf-8">
  <meta name="X-UA-Compatible" content="IE=edge">
  <meta name="google-site-verification" content="">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="telephone=no" name="format-detection">
  <meta name="description" content="업무 자동화">
  <meta name="renderer" content="webkit">
  <meta name="theme-color" content="#ffffff">

  
  
  <meta property="og:title" content="Load Balancer를 활용해서 배포 프로세스를 개선해보자" />
<meta property="og:description" content="업무 자동화" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://markruler.github.io/posts/ci/ci-with-lb/" /><meta property="og:image" content="https://markruler.github.io/images/ci/old-system-2022.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-17T03:44:00+09:00" />
<meta property="article:modified_time" content="2022-08-17T03:44:00+09:00" /><meta property="og:site_name" content="임창수 블로그" />


  

  
  
  <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://markruler.github.io/images/ci/old-system-2022.png"/>

<meta name="twitter:title" content="Load Balancer를 활용해서 배포 프로세스를 개선해보자"/>
<meta name="twitter:description" content="업무 자동화"/>

  

  
  <meta name="google-site-verification" content="60VmMXH5SqMxrPFmaJ27RuE-pn2Yg7hw1BtEkXLmOwc" />
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FFMDWZ27TN"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-FFMDWZ27TN');
  </script>

  
  

  <script src="/vendor/js/jquery.min.js" ></script>
  <script src="/vendor/js/popper.min.js" ></script>
  <script src="/vendor/js/bootstrap.min.js" ></script>
  <script src="/vendor/js/smooth-scroll.polyfills.min.js" ></script>
  <link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">
  <script src="/vendor/js/vue.min.js" ></script>

  

  
  <link rel="icon" href="https://markruler.github.io/images/favicon.ico">
  
  

  
  
  
  <link rel="stylesheet" href="https://markruler.github.io/scss/dark-mode.min.4c4033ff4494b2f0a0c5e7c899105f5abe76b2f05e54a45b5044a3bf6016c74c.css" integrity="sha256-TEAz/0SUsvCgxefImRBfWr52svBeVKRbUESjv2AWx0w=" media="screen">
  

  <script src="https://markruler.github.io//js/loadCSS.js"></script>
  <script>
    loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons");
  </script>

  

  
  
  <script src="https://markruler.github.io//js/toc.js"></script>
  
  

  

  

  

  

</head>
<body>
  <div id="app"><div ref="sideContainer" class="side-container">

  <a class="a-block nav-head false" href="https://markruler.github.io/">

  <div class="nav-title">
    Im Changsu
  </div>
  
    <div class="nav-subtitle">
      What, Why, How.
    </div>
  
  </a>
  <div class="nav-link-list">
    
    
    
    
    
    
    
    <a class="a-block nav-link-item false" href="/about">
      About
    </a>
    
    
    
    
    
    
    
    
    
    <a class="a-block nav-link-item active" href="/posts">
      Posts
    </a>
    
    
    
    
    
    
    
    <a class="a-block nav-link-item false" href="/categories">
      Categories
    </a>
    
    
    
    
    
    
    
    <a class="a-block nav-link-item false" href="/tags">
      Tags
    </a>
    
    
    
    
    
    
    
    <a class="a-block nav-link-item false" href="/index.xml">
      RSS Feed
    </a>
    
    
  </div>

  <div class="nav-footer">
    


&copy;
	
	Im Changsu 2020 - 2022
	

  </div>

</div><div ref="extraContainer" class="extra-container">
    
    
    
    <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- TOC -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%ea%b0%9c%ec%9a%94" onclick="onNavClick(`#개요-nav`)" id="개요-nav">
									개요
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#%ea%b8%b0%ec%a1%b4-%ed%94%84%eb%a1%9c%ec%84%b8%ec%8a%a4" onclick="onNavClick(`#기존-프로세스-nav`)" id="기존-프로세스-nav">
									기존 프로세스
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%ea%b0%9c%ec%84%a0-%ed%94%84%eb%a1%9c%ec%84%b8%ec%8a%a4-continuous-delivery" onclick="onNavClick(`#개선-프로세스-continuous-delivery-nav`)" id="개선-프로세스-continuous-delivery-nav">
									개선 프로세스 (Continuous Delivery)
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%eb%8f%84%ec%9e%85-%ea%b3%bc%ec%a0%95%ec%97%90%ec%84%9c-%eb%b0%9c%ec%83%9d%ed%95%9c-%eb%ac%b8%ec%a0%9c%eb%93%a4" onclick="onNavClick(`#도입-과정에서-발생한-문제들-nav`)" id="도입-과정에서-발생한-문제들-nav">
									도입 과정에서 발생한 문제들
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#active-health-check%ea%b0%80-%ed%95%84%ec%9a%94%ed%95%98%eb%8b%a4" onclick="onNavClick(`#active-health-check가-필요하다-nav`)" id="active-health-check가-필요하다-nav">
									Active Health Check가 필요하다
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#iptables-%ec%84%9c%eb%b9%84%ec%8a%a4%eb%a5%bc-%eb%8b%a4%ec%8b%9c-%ec%8b%9c%ec%9e%91%ed%95%b4%ec%95%bc-%ed%95%a0-%eb%95%8c" onclick="onNavClick(`#iptables-서비스를-다시-시작해야-할-때-nav`)" id="iptables-서비스를-다시-시작해야-할-때-nav">
									iptables 서비스를 다시 시작해야 할 때
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#httpd%eb%a5%bc-%eb%8b%a4%ec%8b%9c-%ec%8b%a4%ed%96%89%ed%95%b4%ec%95%bc-%ed%95%a0-%eb%95%8c" onclick="onNavClick(`#httpd를-다시-실행해야-할-때-nav`)" id="httpd를-다시-실행해야-할-때-nav">
									httpd를 다시 실행해야 할 때
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%ea%b0%9c%ec%84%a0%ec%9d%98-%ec%97%ac%ec%a7%80%ea%b0%80-%ec%9e%88%eb%8b%a4" onclick="onNavClick(`#개선의-여지가-있다-nav`)" id="개선의-여지가-있다-nav">
									개선의 여지가 있다
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#sessionrepositoryfilter-%ec%97%90%eb%9f%ac-%ed%8e%98%ec%9d%b4%ec%a7%80-%ec%9d%91%eb%8b%b5" onclick="onNavClick(`#sessionrepositoryfilter-에러-페이지-응답-nav`)" id="sessionrepositoryfilter-에러-페이지-응답-nav">
									SessionRepositoryFilter 에러 페이지 응답
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#proxy" onclick="onNavClick(`#proxy-nav`)" id="proxy-nav">
									Proxy
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#akamai-%ec%97%90%eb%9f%ac-%ed%8e%98%ec%9d%b4%ec%a7%80-%ec%9d%91%eb%8b%b5" onclick="onNavClick(`#akamai-에러-페이지-응답-nav`)" id="akamai-에러-페이지-응답-nav">
									Akamai 에러 페이지 응답
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#haproxy-%ec%a0%84%ed%99%98" onclick="onNavClick(`#haproxy-전환-nav`)" id="haproxy-전환-nav">
									HAProxy 전환
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%ec%84%a0%ec%96%b8%ed%98%95-%eb%b0%b0%ed%8f%ac-gitops" onclick="onNavClick(`#선언형-배포-gitops-nav`)" id="선언형-배포-gitops-nav">
									선언형 배포 (GitOps?)
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%eb%8d%94-%ec%9d%bd%ec%9d%84-%ea%b1%b0%eb%a6%ac" onclick="onNavClick(`#더-읽을-거리-nav`)" id="더-읽을-거리-nav">
									더 읽을 거리
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#%ea%b0%81%ec%a3%bc" onclick="onNavClick(`#각주-nav`)" id="각주-nav">
									각주
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a class="pagination-action" v-on:click="toggleDarkMode">
            <i class="material-icons pagination-action-icon" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons pagination-action-icon" v-else="isDarkMode">
                brightness_7
            </i>
        </a>
        
        
    </div>
</div>
<div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/about">
                    About
                </a>
                
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/posts">
                    Posts
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    Categories
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    Tags
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS Feed
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- TOC -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%ea%b0%9c%ec%9a%94" onclick="onNavClick(`#개요-nav`)" id="개요-nav">
									개요
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#%ea%b8%b0%ec%a1%b4-%ed%94%84%eb%a1%9c%ec%84%b8%ec%8a%a4" onclick="onNavClick(`#기존-프로세스-nav`)" id="기존-프로세스-nav">
									기존 프로세스
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%ea%b0%9c%ec%84%a0-%ed%94%84%eb%a1%9c%ec%84%b8%ec%8a%a4-continuous-delivery" onclick="onNavClick(`#개선-프로세스-continuous-delivery-nav`)" id="개선-프로세스-continuous-delivery-nav">
									개선 프로세스 (Continuous Delivery)
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%eb%8f%84%ec%9e%85-%ea%b3%bc%ec%a0%95%ec%97%90%ec%84%9c-%eb%b0%9c%ec%83%9d%ed%95%9c-%eb%ac%b8%ec%a0%9c%eb%93%a4" onclick="onNavClick(`#도입-과정에서-발생한-문제들-nav`)" id="도입-과정에서-발생한-문제들-nav">
									도입 과정에서 발생한 문제들
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#active-health-check%ea%b0%80-%ed%95%84%ec%9a%94%ed%95%98%eb%8b%a4" onclick="onNavClick(`#active-health-check가-필요하다-nav`)" id="active-health-check가-필요하다-nav">
									Active Health Check가 필요하다
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#iptables-%ec%84%9c%eb%b9%84%ec%8a%a4%eb%a5%bc-%eb%8b%a4%ec%8b%9c-%ec%8b%9c%ec%9e%91%ed%95%b4%ec%95%bc-%ed%95%a0-%eb%95%8c" onclick="onNavClick(`#iptables-서비스를-다시-시작해야-할-때-nav`)" id="iptables-서비스를-다시-시작해야-할-때-nav">
									iptables 서비스를 다시 시작해야 할 때
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#httpd%eb%a5%bc-%eb%8b%a4%ec%8b%9c-%ec%8b%a4%ed%96%89%ed%95%b4%ec%95%bc-%ed%95%a0-%eb%95%8c" onclick="onNavClick(`#httpd를-다시-실행해야-할-때-nav`)" id="httpd를-다시-실행해야-할-때-nav">
									httpd를 다시 실행해야 할 때
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%ea%b0%9c%ec%84%a0%ec%9d%98-%ec%97%ac%ec%a7%80%ea%b0%80-%ec%9e%88%eb%8b%a4" onclick="onNavClick(`#개선의-여지가-있다-nav`)" id="개선의-여지가-있다-nav">
									개선의 여지가 있다
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#sessionrepositoryfilter-%ec%97%90%eb%9f%ac-%ed%8e%98%ec%9d%b4%ec%a7%80-%ec%9d%91%eb%8b%b5" onclick="onNavClick(`#sessionrepositoryfilter-에러-페이지-응답-nav`)" id="sessionrepositoryfilter-에러-페이지-응답-nav">
									SessionRepositoryFilter 에러 페이지 응답
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#proxy" onclick="onNavClick(`#proxy-nav`)" id="proxy-nav">
									Proxy
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#akamai-%ec%97%90%eb%9f%ac-%ed%8e%98%ec%9d%b4%ec%a7%80-%ec%9d%91%eb%8b%b5" onclick="onNavClick(`#akamai-에러-페이지-응답-nav`)" id="akamai-에러-페이지-응답-nav">
									Akamai 에러 페이지 응답
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#haproxy-%ec%a0%84%ed%99%98" onclick="onNavClick(`#haproxy-전환-nav`)" id="haproxy-전환-nav">
									HAProxy 전환
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%ec%84%a0%ec%96%b8%ed%98%95-%eb%b0%b0%ed%8f%ac-gitops" onclick="onNavClick(`#선언형-배포-gitops-nav`)" id="선언형-배포-gitops-nav">
									선언형 배포 (GitOps?)
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%eb%8d%94-%ec%9d%bd%ec%9d%84-%ea%b1%b0%eb%a6%ac" onclick="onNavClick(`#더-읽을-거리-nav`)" id="더-읽을-거리-nav">
									더 읽을 거리
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#%ea%b0%81%ec%a3%bc" onclick="onNavClick(`#각주-nav`)" id="각주-nav">
									각주
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="https://markruler.github.io/">
            
        </a>
        
        <button type="button" class="nav-darkmode-toggle" v-on:click="toggleDarkMode">
            <i class="material-icons" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons" v-else="isDarkMode">
                brightness_7
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://markruler.github.io/">
        <div class="single-column-header-title"></div>
        
        <div class="single-column-header-subtitle">Im Changsu</div>
        

    </a>
</div>

    <div id="content">
<div ref="streamContainer" class="stream-container">
  <div class="post-list-container post-list-container-shadow">
    <div class="post">
      
      
      
      
      

      <div class="post-head-wrapper"  
        
        style="background-image: url('https://markruler.github.io/images/ci/old-system-2022.png')"  >
        <div class="post-title">
          Load Balancer를 활용해서 배포 프로세스를 개선해보자
          
          <div class="post-subtitle">
            업무 자동화
          </div>
          
          <div class="post-meta">
            
            <time itemprop="datePublished">
              2022년 08월 17일 03시 44분
            </time>
            

            
            <i class="material-icons" style="">folder</i>
            <a href="/categories/">[devops]</a>
            &nbsp;
            

            
            <i class="material-icons" style="">label</i>
            
            <a href="/tags/ci">ci</a>
            &nbsp;
            
            <a href="/tags/cd">cd</a>
            &nbsp;
            
            <a href="/tags/bamboo">bamboo</a>
            &nbsp;
            
            <a href="/tags/git">git</a>
            &nbsp;
            
            
            
          </div>
        </div>
      </div>

      <div class="post-body-wrapper">
        
          <div class="post-body" v-pre>
            
            <h1 id="개요">개요</h1>
<p>현재 팀에서 빌드-배포 도구로 Bamboo를 사용하고 있다.
놀랍게도 개발자가 커밋한 소스 코드를 운영 환경에 반영하기까지 14단계의 수동 작업이 필요했다.
그래서 개발팀 모두가 배포 작업에 많은 부담을 갖고 있었다.
한번 빌드하고 배포하는데 최소 30분에서 길면 1시간까지 걸리는 이 불필요한 시간을 줄이고 싶었다.</p>
<p><img src="/images/ci/old-system-2022.png" alt="개발중인 서비스의 기존 시스템"></p>
<p><em>화살표 방향은 단순히 요청의 흐름을 나타낸다.</em></p>
<p>단일 서버의 처리량(Capacity)을 초과한 대량 요청 트래픽은 속도 저하나 서비스 지연 또는 장애를 유발한다.
이 상황을 대비해 부하(Load)를 여러 서버로 분산(Balancing)하는 것을 서버 로드 밸런싱(SLB: Server Load Balancing)이라고 한다.<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>
기존 운영 환경에서는 Alteon Application Switch를 Layer 4 로드 밸런서로 사용하고 있었다.
하지만 80번 포트에 대한 Layer 4 헬스체크만 하고 있었기 때문에 애플리케이션 배포 시 연결을 비활성화해야 했다.
배포 작업의 대부분이 이 작업에 의존했다.
웹 애플리케이션이 실행 중인 서버에 Apache HTTP 서버(<code>httpd</code>)도 있었기 때문에 가장 빠르고 효과적인 해결책으로 Layer 7 Load Balancing 기능을 생각했다.
정리하자면 기존 프로세스와 개선 프로세스는 다음과 같다.</p>
<h2 id="기존-프로세스">기존 프로세스</h2>
<ol>
<li>
<p>코드 리뷰를 마치고 소스 코드가 배포 브랜치에 병합되면 버튼을 눌러 빌드한다.</p>
<ul>
<li>대부분의 이슈들은 2개의 애플리케이션(<code>:38888</code>, <code>:39999</code>)에 함께 반영된다.</li>
</ul>
</li>
<li>
<p><code>telnet</code> 을 사용해서 Alteon Switch에 접속한다.</p>
</li>
<li>
<p>배포하기 전에 서비스 도메인(<code>d1.markruler.com</code>, <code>d2.markruler.com</code>)에 접속할 수 있는지 확인한다.</p>
</li>
<li>
<p>가상 호스트(vhost)에 묶여 있는 <code>s1</code> 서버를 비활성화한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-s" data-lang="s"><span style="color:#ff79c6">&gt;&gt;</span> Server Load Balancing Information<span style="color:#6272a4"># /info/slb/virt 1</span>
   <span style="color:#bd93f9">1</span><span style="color:#ff79c6">:</span> IP4 <span style="color:#ff79c6">&lt;</span>vhost_IP_Address<span style="color:#ff79c6">&gt;</span>,   <span style="color:#bd93f9">00</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">00</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">00</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">00</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">00</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">00</span>
    virtual ports<span style="color:#ff79c6">:</span>
    http<span style="color:#ff79c6">:</span> rport http, group <span style="color:#bd93f9">1</span>, backup none, rtspslb none
        real servers<span style="color:#ff79c6">:</span>
           <span style="color:#bd93f9">1</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">&lt;</span>s1_IP_Address<span style="color:#ff79c6">&gt;</span>, backup none, <span style="color:#bd93f9">0</span> ms, group ena, up
           <span style="color:#bd93f9">2</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">&lt;</span>s2_IP_Address<span style="color:#ff79c6">&gt;</span>, backup none, <span style="color:#bd93f9">0</span> ms, group ena, up
    https<span style="color:#ff79c6">:</span> rport https, group <span style="color:#bd93f9">1</span>, backup none, rtspslb none
        real servers<span style="color:#ff79c6">:</span>
           <span style="color:#bd93f9">1</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">&lt;</span>s1_IP_Address<span style="color:#ff79c6">&gt;</span>, backup none, <span style="color:#bd93f9">0</span> ms, group ena, up
           <span style="color:#bd93f9">2</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">&lt;</span>s2_IP_Address<span style="color:#ff79c6">&gt;</span>, backup none, <span style="color:#bd93f9">0</span> ms, group ena, up
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-s" data-lang="s"><span style="color:#ff79c6">&gt;&gt;</span> Main<span style="color:#6272a4"># /cfg/slb/real 1/dis</span>
Current status<span style="color:#ff79c6">:</span> enabled
New status<span style="color:#ff79c6">:</span>     disabled

<span style="color:#ff79c6">&gt;&gt;</span> Main<span style="color:#6272a4"># apply</span>
</code></pre></div></li>
<li>
<p>다시 3번과 동일하게 서비스 도메인에 접속할 수 있는지 확인한다.</p>
</li>
<li>
<p>Bamboo를 사용해서 새로운 버전의 애플리케이션 2개(<code>s1:38888</code>, <code>s1:39999</code>)를 배포한다.</p>
</li>
<li>
<p>배포 스크립트에서 별도로 헬스체크를 하지 않기 때문에 수동으로 접속할 수 있는지 확인(&ldquo;새로 고침&rdquo;)한다.</p>
</li>
<li>
<p>정상적으로 접속되면 Alteon Switch에서 <code>s1</code> 서버를 활성화한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-s" data-lang="s"><span style="color:#ff79c6">&gt;&gt;</span> Main<span style="color:#6272a4"># /cfg/slb/real 1/ena</span>
Current status<span style="color:#ff79c6">:</span> disabled
New status<span style="color:#ff79c6">:</span>     enabled

<span style="color:#ff79c6">&gt;&gt;</span> Main<span style="color:#6272a4"># apply</span>
</code></pre></div></li>
<li>
<p>그 후 <code>s2</code> 서버를 비활성화한다. (8번과 동시에 적용하면 Akamai CDN 서비스에서 <a href="#akamai-%EC%97%90%EB%9F%AC-%ED%8E%98%EC%9D%B4%EC%A7%80-%EC%9D%91%EB%8B%B5"><code>ERR_ZERO_SIZE_OBJECT</code> 에러가 발생할 수 있다</a>)</p>
</li>
<li>
<p>다시 3번과 동일하게 서비스 도메인에 접속할 수  있는지 확인한다.</p>
</li>
<li>
<p>Bamboo에서 새로운 버전의 애플리케이션 2개(<code>s2:38888</code>, <code>s2:39999</code>)를 배포한다.</p>
</li>
<li>
<p>다시 7번과 동일한 이유로 서비스 도메인에 접속할 수  있는지 확인한다.</p>
</li>
<li>
<p>모두 접속되면 Alteon Switch에서 <code>s2</code> 서버를 활성화한다.</p>
</li>
<li>
<p>마지막으로 반영 사항을 갈무리해서 업무 메신저에 공유한다.</p>
</li>
</ol>
<h2 id="개선-프로세스-continuous-delivery">개선 프로세스 (Continuous Delivery)</h2>
<p>웹 서버가 동일 머신에 있는 웹 애플리케이션만 바라보는 것이 아니라 다른 머신에 있는 서버도 바라보도록 설정했다.</p>
<p><img src="/images/ci/new-system-2022.png" alt="개발중인 서비스의 새로운 시스템"></p>
<blockquote>
<p>총 14단계에서 2단계까지 줄였다.
먼저 코드 리뷰를 마치고 소스 코드가 통합 브랜치(trunk)에 병합되면 자동으로 빌드된다.</p>
</blockquote>
<ol>
<li>
<p>운영 환경에 반영하기 위해 배포 버튼을 누른다.</p>
<ul>
<li>
<p>쉘 스크립트를 활용해 자동으로 새로운 버전의 애플리케이션을 배포하고 헬스체크한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash"><span style="color:#ff79c6">#!/usr/bin/env bash
</span><span style="color:#ff79c6"></span>
<span style="color:#ff79c6">while</span> ! curl --silent --output /dev/null --head --fail --max-time <span style="color:#bd93f9">3</span> --location <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">1</span><span style="color:#f1fa8c">}</span>; <span style="color:#ff79c6">do</span>
  <span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;Healthchecking...</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">1</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>
  sleep <span style="color:#bd93f9">2</span>
<span style="color:#ff79c6">done</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p>마지막으로 반영 사항을 갈무리해서 업무 메신저에 공유한다.</p>
</li>
</ol>
<h1 id="도입-과정에서-발생한-문제들">도입 과정에서 발생한 문제들</h1>
<h2 id="active-health-check가-필요하다">Active Health Check가 필요하다</h2>
<blockquote>
<p><a href="https://www.haproxy.com/documentation/hapee/2-5r1/load-balancing/health-checking/active-health-checks/">Active Health Check</a>란
주기적으로 서버에 연결을 시도하거나 HTTP 요청을 보내서 서버 상태를 확인한다.
반면 <a href="https://www.haproxy.com/documentation/hapee/2-5r1/load-balancing/health-checking/passive-health-checks/">Passive Health Check</a>는
오류가 있는지 활성 트래픽(active traffic)만 검사한다.</p>
</blockquote>
<p><code>s1</code> 과 <code>s2</code> 서버에는 CentOS 7이 설치되어있다.
해당 OS에서는 httpd를 <strong>2.4.6 버전</strong>까지만 업데이트 할 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">&gt; yum info httpd
...
Available Packages
Name        : httpd
Arch        : x86_64
Version     : 2.4.6
...
</code></pre></div><p>Layer 7 헬스체크를 위한 <code>mod_proxy_hcheck</code> 모듈은
<strong>2.4.21 버전</strong>부터 사용할 수 있기 때문에 OS 변경이 불가피했다.
하지만 클라우드 컴퓨트 서비스를 사용하는 것이 아닌
IDC 물리 서버를 사용하고 있었기 때문에 OS 교체는 상당히 큰 부담이었다.
그래서 컨테이너를 도입하기로 결정했다.</p>
<p>설정 파일(<code>httpd.conf</code>)은 기존 설정을 최대한 그대로 사용하기로 했다.
<code>volumes</code> 경로는 어느 환경에서든 동일하도록 가급적 절대 경로를 사용했다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">&gt; <span style="color:#8be9fd;font-style:italic">cd</span> <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">HOME</span><span style="color:#f1fa8c">}</span>/httpd
&gt; ls
docker-compose.yaml  httpd.conf
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-yaml" data-lang="yaml"><span style="color:#6272a4"># docker-compose.yaml</span>
<span style="color:#ff79c6">version</span>: <span style="color:#f1fa8c">&#34;3.8&#34;</span>

<span style="color:#ff79c6">services</span>:
  <span style="color:#ff79c6">slb</span>:
    <span style="color:#ff79c6">image</span>: httpd:2.4.54-alpine
    <span style="color:#ff79c6">container_name</span>: slb
    <span style="color:#ff79c6">hostname</span>: markruler.com
    <span style="color:#ff79c6">ports</span>:
      - <span style="color:#bd93f9">80</span>:<span style="color:#bd93f9">80</span>
      - <span style="color:#bd93f9">443</span>:<span style="color:#bd93f9">443</span>
    <span style="color:#ff79c6">volumes</span>:
      <span style="color:#6272a4"># httpd</span>
      - <span style="color:#f1fa8c">&#39;/home/markruler/httpd/httpd.conf:/usr/local/apache2/conf/httpd.conf&#39;</span>

      <span style="color:#6272a4"># logs</span>
      - <span style="color:#f1fa8c">&#39;/etc/httpd/logs/d1.markruler:/usr/local/apache2/logs/d1.markruler&#39;</span>

      <span style="color:#6272a4"># SSL</span>
      - <span style="color:#f1fa8c">&#39;/etc/ssl/certs/d1.crt:/etc/ssl/certs/d1/cert.pem&#39;</span>
      - <span style="color:#f1fa8c">&#39;/etc/ssl/certs/d1.key:/etc/ssl/certs/d1/privkey.pem&#39;</span>
      - <span style="color:#f1fa8c">&#39;/etc/ssl/certs/d1.chain.crt:/etc/ssl/certs/d1/chain.pem&#39;</span>
      - <span style="color:#f1fa8c">&#39;/etc/ssl/certs/CA_AAA_CERTIFICATE_SERVICES.crt:/etc/ssl/certs/d1/ca.pem&#39;</span>

      <span style="color:#6272a4"># SSL Key Password</span>
      - <span style="color:#f1fa8c">&#39;/etc/ssl/certs/key_password.sh:/etc/ssl/certs/d1/key_password.sh&#39;</span>

<span style="color:#ff79c6">networks</span>:
  <span style="color:#ff79c6">default</span>:
    <span style="color:#ff79c6">driver_opts</span>:
      <span style="color:#ff79c6">com.docker.network.enable_ipv6</span>: <span style="color:#f1fa8c">&#34;false&#34;</span>
    <span style="color:#ff79c6">ipam</span>:
      <span style="color:#ff79c6">driver</span>: default
      <span style="color:#ff79c6">config</span>:
        - <span style="color:#ff79c6">subnet</span>: <span style="color:#bd93f9">172.18.0.0</span>/16 <span style="color:#6272a4"># 255.255.0.0</span>
          <span style="color:#ff79c6">gateway</span>: <span style="color:#bd93f9">172.18.0.1</span>
</code></pre></div><p><code>httpd -t</code> 명령어로 서버 실행 전 설정 파일을 검증할 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">sudo docker compose run --rm slb httpd -t
</code></pre></div><p><code>up</code> 명령어로 서버를 실행한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash"><span style="color:#6272a4"># sudo docker compose up --detach</span>
sudo docker compose -f <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">HOME</span><span style="color:#f1fa8c">}</span>/httpd/docker-compose.yaml up -d
</code></pre></div><p><code>docker inspect</code> 명령어로 실제 실행된 컨테이너의 정보를 확인할 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">sudo docker inspect slb
</code></pre></div><h2 id="iptables-서비스를-다시-시작해야-할-때">iptables 서비스를 다시 시작해야 할 때</h2>
<p>iptables 서비스를 다시 시작하면 <code>/etc/sysconfig/iptables</code> 파일에
있는 규칙들만 적용되기 때문에 Docker에서 설정하는 iptables 규칙이 사라진다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">&gt; systemctl restart iptables
</code></pre></div><p>실제로 Docker 도입 사실을 IDC 매니저와 공유하지 않았다가 문제가 발생했다.
IDC 매니저가 우리 회사 측 요청으로 iptables 규칙을 변경하고 재시작했는데
해당 서버의 Docker 네트워크 규칙들이 사라져서 컨테이너가 실행되지 못하고 있었다.
현재는 iptables를 재실행할 때 Docker도 같이 재실행한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">&gt; systemctl restart docker
&gt; iptables -nvL
</code></pre></div><p>추가로 컨테이너에서 각 서비스로 트래픽을 보내기 위해 iptables 규칙을 추가한다.
Docker 데몬은 기본적으로 <code>docker0</code> 라는 브릿지 네트워크 인터페이스를 사용하는데 IP address range를
<a href="https://github.com/moby/moby/blob/a77317882d010b884a9101c6ad0b2d7db141082f/libnetwork/docs/network.md">172.17.0.1/16</a> 으로 설정한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">&gt; ip -br -c a
lo               UNKNOWN        127.0.0.1/8 ::1/128
docker0          DOWN           172.17.0.1/16 <span style="color:#6272a4"># HERE!</span>
</code></pre></div><p>iptables 규칙을 추가하기 위해 해당 네트워크를 고정시켰다.
<a href="https://docs.docker.com/network/bridge/">bip</a>는 Docker 데몬이 사용할 bridge network IP address range를 지정하는 옵션이다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sh" data-lang="sh"><span style="color:#6272a4"># 기본 설정</span>
cat <span style="color:#f1fa8c">&lt;&lt;EOF | sudo tee /etc/docker/daemon.json
</span><span style="color:#f1fa8c">{
</span><span style="color:#f1fa8c">  &#34;bip&#34;: &#34;172.17.0.1/16&#34;
</span><span style="color:#f1fa8c">}
</span><span style="color:#f1fa8c">EOF</span>
</code></pre></div><p>Docker 데몬을 재시작하면 <code>docker0</code> 네트워크 인터페이스가 변경되어 있을 것이다.
이제 컨테이너에서 웹 애플리케이션으로 패킷을 전달할 수 있도록 iptables 규칙을 추가한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">&gt; vi /etc/sysconfig/iptables

-A INPUT -m state --state NEW -s 172.16.0.0/12 -m tcp -p tcp --dport <span style="color:#bd93f9">38888</span> -j ACCEPT
-A INPUT -m state --state NEW -s 172.16.0.0/12 -m tcp -p tcp --dport <span style="color:#bd93f9">39999</span> -j ACCEPT
</code></pre></div><p><code>172.16.0.0/12</code> 로 설정한 이유는 docker-compose로 컨테이너를 실행할 경우
이미 있는 인터페이스가 아닌 추가 인터페이스를 생성하기 때문이다.
만약 <code>docker0</code> 와 동일한 <code>172.17.0.1/16</code> 으로 생성하려고 시도하면 아래와 같은 에러가 발생한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">failed to create network httpd_default: Error response from daemon: Pool overlaps with other one on this address space
</code></pre></div><p>Docker에서 추가 인터페이스를 생성할 때 <code>172.17-31.x.x/16</code>, <code>192.168.x.x/20</code> 범위에서 추가하게 된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#6272a4">// https://github.com/moby/moby/blob/df650a1aeb190a319287c4d26bd3593b5343fb72/libnetwork/ipamutils/utils.go
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">var</span> (
  <span style="color:#6272a4">// PredefinedLocalScopeDefaultNetworks contains a list of 31 IPv4 private networks with host size 16 and 12
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// (172.17-31.x.x/16, 192.168.x.x/20) which do not overlap with the networks in `PredefinedGlobalScopeDefaultNetworks`
</span><span style="color:#6272a4"></span>  PredefinedLocalScopeDefaultNetworks []<span style="color:#ff79c6">*</span>net.IPNet
  <span style="color:#6272a4">// PredefinedGlobalScopeDefaultNetworks contains a list of 64K IPv4 private networks with host size 8
</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// (10.x.x.x/24) which do not overlap with the networks in `PredefinedLocalScopeDefaultNetworks`
</span><span style="color:#6272a4"></span>  PredefinedGlobalScopeDefaultNetworks []<span style="color:#ff79c6">*</span>net.IPNet
  mutex                                sync.Mutex
  localScopeDefaultNetworks = []<span style="color:#ff79c6">*</span>NetworkToSplit{{<span style="color:#f1fa8c">&#34;172.17.0.0/16&#34;</span>, <span style="color:#bd93f9">16</span>},
                                                {<span style="color:#f1fa8c">&#34;172.18.0.0/16&#34;</span>, <span style="color:#bd93f9">16</span>},
                                                {<span style="color:#f1fa8c">&#34;172.19.0.0/16&#34;</span>, <span style="color:#bd93f9">16</span>},
                                                {<span style="color:#f1fa8c">&#34;172.20.0.0/14&#34;</span>, <span style="color:#bd93f9">16</span>},
                                                {<span style="color:#f1fa8c">&#34;172.24.0.0/14&#34;</span>, <span style="color:#bd93f9">16</span>},
                                                {<span style="color:#f1fa8c">&#34;172.28.0.0/14&#34;</span>, <span style="color:#bd93f9">16</span>},
                                                {<span style="color:#f1fa8c">&#34;192.168.0.0/16&#34;</span>, <span style="color:#bd93f9">20</span>}}
  globalScopeDefaultNetworks = []<span style="color:#ff79c6">*</span>NetworkToSplit{{<span style="color:#f1fa8c">&#34;10.0.0.0/8&#34;</span>, <span style="color:#bd93f9">24</span>}}
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">init</span>() {
  <span style="color:#8be9fd;font-style:italic">var</span> err <span style="color:#8be9fd">error</span>
  <span style="color:#ff79c6">if</span> PredefinedGlobalScopeDefaultNetworks, err = <span style="color:#50fa7b">splitNetworks</span>(globalScopeDefaultNetworks); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
    <span style="color:#8be9fd;font-style:italic">panic</span>(<span style="color:#f1fa8c">&#34;failed to initialize the global scope default address pool: &#34;</span> <span style="color:#ff79c6">+</span> err.<span style="color:#50fa7b">Error</span>())
  }

  <span style="color:#ff79c6">if</span> PredefinedLocalScopeDefaultNetworks, err = <span style="color:#50fa7b">splitNetworks</span>(localScopeDefaultNetworks); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
    <span style="color:#8be9fd;font-style:italic">panic</span>(<span style="color:#f1fa8c">&#34;failed to initialize the local scope default address pool: &#34;</span> <span style="color:#ff79c6">+</span> err.<span style="color:#50fa7b">Error</span>())
  }
}
</code></pre></div><p>만약 범위를 변경하고 싶다면 <a href="https://docs.mirantis.com/mke/3.4/install/plan-deployment/mcr-considerations/default-address-pools.html">Mirantis 문서</a>처럼 <code>default-address-pools</code> 옵션을 직접 추가할 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go">{
  <span style="color:#f1fa8c">&#34;default-address-pools&#34;</span>: [
    {<span style="color:#f1fa8c">&#34;base&#34;</span>:<span style="color:#f1fa8c">&#34;172.17.0.0/16&#34;</span>,<span style="color:#f1fa8c">&#34;size&#34;</span>:<span style="color:#bd93f9">16</span>}, <span style="color:#ff79c6">&lt;--</span> docker0
    {<span style="color:#f1fa8c">&#34;base&#34;</span>:<span style="color:#f1fa8c">&#34;172.18.0.0/16&#34;</span>,<span style="color:#f1fa8c">&#34;size&#34;</span>:<span style="color:#bd93f9">16</span>},
    {<span style="color:#f1fa8c">&#34;base&#34;</span>:<span style="color:#f1fa8c">&#34;172.19.0.0/16&#34;</span>,<span style="color:#f1fa8c">&#34;size&#34;</span>:<span style="color:#bd93f9">16</span>},
    {<span style="color:#f1fa8c">&#34;base&#34;</span>:<span style="color:#f1fa8c">&#34;172.20.0.0/16&#34;</span>,<span style="color:#f1fa8c">&#34;size&#34;</span>:<span style="color:#bd93f9">16</span>},
    {<span style="color:#f1fa8c">&#34;base&#34;</span>:<span style="color:#f1fa8c">&#34;172.21.0.0/16&#34;</span>,<span style="color:#f1fa8c">&#34;size&#34;</span>:<span style="color:#bd93f9">16</span>},
    {<span style="color:#f1fa8c">&#34;base&#34;</span>:<span style="color:#f1fa8c">&#34;172.22.0.0/16&#34;</span>,<span style="color:#f1fa8c">&#34;size&#34;</span>:<span style="color:#bd93f9">16</span>},
    {<span style="color:#f1fa8c">&#34;base&#34;</span>:<span style="color:#f1fa8c">&#34;172.23.0.0/16&#34;</span>,<span style="color:#f1fa8c">&#34;size&#34;</span>:<span style="color:#bd93f9">16</span>},
    {<span style="color:#f1fa8c">&#34;base&#34;</span>:<span style="color:#f1fa8c">&#34;172.24.0.0/16&#34;</span>,<span style="color:#f1fa8c">&#34;size&#34;</span>:<span style="color:#bd93f9">16</span>},
    {<span style="color:#f1fa8c">&#34;base&#34;</span>:<span style="color:#f1fa8c">&#34;172.25.0.0/16&#34;</span>,<span style="color:#f1fa8c">&#34;size&#34;</span>:<span style="color:#bd93f9">16</span>},
    {<span style="color:#f1fa8c">&#34;base&#34;</span>:<span style="color:#f1fa8c">&#34;172.26.0.0/16&#34;</span>,<span style="color:#f1fa8c">&#34;size&#34;</span>:<span style="color:#bd93f9">16</span>},
    {<span style="color:#f1fa8c">&#34;base&#34;</span>:<span style="color:#f1fa8c">&#34;172.27.0.0/16&#34;</span>,<span style="color:#f1fa8c">&#34;size&#34;</span>:<span style="color:#bd93f9">16</span>},
    {<span style="color:#f1fa8c">&#34;base&#34;</span>:<span style="color:#f1fa8c">&#34;172.28.0.0/16&#34;</span>,<span style="color:#f1fa8c">&#34;size&#34;</span>:<span style="color:#bd93f9">16</span>},
    {<span style="color:#f1fa8c">&#34;base&#34;</span>:<span style="color:#f1fa8c">&#34;172.29.0.0/16&#34;</span>,<span style="color:#f1fa8c">&#34;size&#34;</span>:<span style="color:#bd93f9">16</span>},
    {<span style="color:#f1fa8c">&#34;base&#34;</span>:<span style="color:#f1fa8c">&#34;172.30.0.0/16&#34;</span>,<span style="color:#f1fa8c">&#34;size&#34;</span>:<span style="color:#bd93f9">16</span>},
    {<span style="color:#f1fa8c">&#34;base&#34;</span>:<span style="color:#f1fa8c">&#34;192.168.0.0/16&#34;</span>,<span style="color:#f1fa8c">&#34;size&#34;</span>:<span style="color:#bd93f9">20</span>}
  ]
}
</code></pre></div><p>설정이 끝났다면 iptables를 다시 실행한다.</p>
<h2 id="httpd를-다시-실행해야-할-때">httpd를 다시 실행해야 할 때</h2>
<blockquote>
<p>httpd 컨테이너를 재실행(restart)하지 않고도 설정 파일을 다시 적용(reload)하는 방법을 아직 찾지 못했다.</p>
</blockquote>
<p>테스트 환경의 Alteon Switch에서 Layer 4 헬스체크가 잘 되는지 확인해 본다.
그러고는 <code>s2</code> 서버의 <code>httpd</code> 를 죽여본다.
<code>FAILED</code> 상태가 되고 트래픽을 보내지 않는다!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-s" data-lang="s"><span style="color:#ff79c6">&gt;&gt;</span> Server Load Balancing Information<span style="color:#6272a4"># /info/slb/virt 1</span>
   <span style="color:#bd93f9">1</span><span style="color:#ff79c6">:</span> IP4 <span style="color:#ff79c6">&lt;</span>vhost_IP_Address<span style="color:#ff79c6">&gt;</span>,   <span style="color:#bd93f9">00</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">00</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">00</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">00</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">00</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">00</span>
    virtual ports<span style="color:#ff79c6">:</span>
    http<span style="color:#ff79c6">:</span> rport http, group <span style="color:#bd93f9">1</span>, backup none, rtspslb none
        real servers<span style="color:#ff79c6">:</span>
           <span style="color:#bd93f9">1</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">&lt;</span>s1_IP_Address<span style="color:#ff79c6">&gt;</span>, backup none, <span style="color:#bd93f9">0</span> ms, group ena, up
           <span style="color:#bd93f9">2</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">&lt;</span>s2_IP_Address<span style="color:#ff79c6">&gt;</span>, backup none, <span style="color:#bd93f9">0</span> ms, group ena, FAILED <span style="color:#6272a4"># HERE!</span>
    https<span style="color:#ff79c6">:</span> rport https, group <span style="color:#bd93f9">1</span>, backup none, rtspslb none
        real servers<span style="color:#ff79c6">:</span>
           <span style="color:#bd93f9">1</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">&lt;</span>s1_IP_Address<span style="color:#ff79c6">&gt;</span>, backup none, <span style="color:#bd93f9">0</span> ms, group ena, up
           <span style="color:#bd93f9">2</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">&lt;</span>s2_IP_Address<span style="color:#ff79c6">&gt;</span>, backup none, <span style="color:#bd93f9">0</span> ms, group ena, FAILED <span style="color:#6272a4"># HERE!</span>
</code></pre></div><p>다시 <code>httpd</code> 를 살려본다.
<code>up</code> 상태가 되고 트래픽을 보낸다!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-s" data-lang="s"><span style="color:#ff79c6">&gt;&gt;</span> Server Load Balancing Information<span style="color:#6272a4"># /info/slb/virt 1</span>
   <span style="color:#bd93f9">1</span><span style="color:#ff79c6">:</span> IP4 <span style="color:#ff79c6">&lt;</span>vhost_IP_Address<span style="color:#ff79c6">&gt;</span>,   <span style="color:#bd93f9">00</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">00</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">00</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">00</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">00</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">00</span>
    virtual ports<span style="color:#ff79c6">:</span>
    http<span style="color:#ff79c6">:</span> rport http, group <span style="color:#bd93f9">1</span>, backup none, rtspslb none, slowstart
        real servers<span style="color:#ff79c6">:</span>
           <span style="color:#bd93f9">1</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">&lt;</span>s1_IP_Address<span style="color:#ff79c6">&gt;</span>, backup none, <span style="color:#bd93f9">0</span> ms, group ena, up
           <span style="color:#bd93f9">2</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">&lt;</span>s2_IP_Address<span style="color:#ff79c6">&gt;</span>, backup none, <span style="color:#bd93f9">0</span> ms, group ena, up <span style="color:#6272a4"># HERE!</span>
    https<span style="color:#ff79c6">:</span> rport https, group <span style="color:#bd93f9">1</span>, backup none, rtspslb none, slowstart
        real servers<span style="color:#ff79c6">:</span>
           <span style="color:#bd93f9">1</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">&lt;</span>s1_IP_Address<span style="color:#ff79c6">&gt;</span>, backup none, <span style="color:#bd93f9">0</span> ms, group ena, up
           <span style="color:#bd93f9">2</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">&lt;</span>s2_IP_Address<span style="color:#ff79c6">&gt;</span>, backup none, <span style="color:#bd93f9">0</span> ms, group ena, up <span style="color:#6272a4"># HERE!</span>
</code></pre></div><h1 id="개선의-여지가-있다">개선의 여지가 있다</h1>
<p>아래에서 언급할 사항들은 위에서 도입한 기술과 별개로 기존에도 발생하던 문제다.</p>
<h2 id="sessionrepositoryfilter-에러-페이지-응답"><code>SessionRepositoryFilter</code> 에러 페이지 응답</h2>
<p>Tomcat Shutdown 직후 일시적으로 응답받을 수 있다. Graceful Shutdown, 요청 재시도(retry) 등을 고려해 볼 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-java" data-lang="java">Type <span style="color:#ff79c6">-</span> Exception report
Message <span style="color:#ff79c6">-</span> Request processing failed<span style="color:#ff79c6">;</span> nested exception is java<span style="color:#ff79c6">.</span><span style="color:#50fa7b">lang</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">NullPointerException</span>
Description <span style="color:#ff79c6">-</span> The server encountered an internal error that prevented it from fulfilling <span style="color:#ff79c6">this</span> request<span style="color:#ff79c6">.</span>

Exception
org<span style="color:#ff79c6">.</span><span style="color:#50fa7b">springframework</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">web</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">util</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">NestedServletException</span><span style="color:#ff79c6">:</span> Request processing failed<span style="color:#ff79c6">;</span> nested exception is java<span style="color:#ff79c6">.</span><span style="color:#50fa7b">lang</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">NullPointerException</span>
  <span style="color:#ff79c6">...</span>
  org<span style="color:#ff79c6">.</span><span style="color:#50fa7b">springframework</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">web</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">filter</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">HttpPutFormContentFilter</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">doFilterInternal</span><span style="color:#ff79c6">(</span>HttpPutFormContentFilter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">java</span><span style="color:#ff79c6">:</span>105<span style="color:#ff79c6">)</span>
  <span style="color:#ff79c6">...</span>
  org<span style="color:#ff79c6">.</span><span style="color:#50fa7b">apache</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">tomcat</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">websocket</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">server</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">WsFilter</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">doFilter</span><span style="color:#ff79c6">(</span>WsFilter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">java</span><span style="color:#ff79c6">:</span>52<span style="color:#ff79c6">)</span>
  org<span style="color:#ff79c6">.</span><span style="color:#50fa7b">apache</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">catalina</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">filters</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">HttpHeaderSecurityFilter</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">doFilter</span><span style="color:#ff79c6">(</span>HttpHeaderSecurityFilter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">java</span><span style="color:#ff79c6">:</span>126<span style="color:#ff79c6">)</span>
  org<span style="color:#ff79c6">.</span><span style="color:#50fa7b">springframework</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">security</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">web</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">FilterChainProxy$VirtualFilterChain</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">doFilter</span><span style="color:#ff79c6">(</span>FilterChainProxy<span style="color:#ff79c6">.</span><span style="color:#50fa7b">java</span><span style="color:#ff79c6">:</span>316<span style="color:#ff79c6">)</span>
  <span style="color:#ff79c6">...</span>

Root Cause
java<span style="color:#ff79c6">.</span><span style="color:#50fa7b">lang</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">NullPointerException</span>
  org<span style="color:#ff79c6">.</span><span style="color:#50fa7b">springframework</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">session</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">web</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">http</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">SessionRepositoryFilter$SessionRepositoryRequestWrapper$SessionCommittingRequestDispatcher</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">forward</span><span style="color:#ff79c6">(</span>SessionRepositoryFilter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">java</span><span style="color:#ff79c6">:</span>447<span style="color:#ff79c6">)</span>
  <span style="color:#ff79c6">...</span>
</code></pre></div><h2 id="proxy">Proxy</h2>
<p>upstream 서버(Tomcat)의 응답이 늦어질 경우 발생할 수 있다.
<code>mod_proxy</code> 의 timeout 값을 조절하여 응답이 늦어지는 경우를 방지할 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-html" data-lang="html"><span style="color:#6272a4">&lt;!-- 502 Bad Gateway --&gt;</span>
Proxy Error

The proxy server received an invalid response from an upstream server.
The proxy server could not handle the request

Reason: Error reading from remote server
</code></pre></div><h2 id="akamai-에러-페이지-응답">Akamai 에러 페이지 응답</h2>
<p>Layer 4 Switch에서 1번 서버와 2번 서버 상태를 동시에 교체할 경우 응답받을 수 있다.
예를 들어, 1번 서버는 <code>disable</code>, 2번 서버는 <code>enable</code> 상태일 때
1번 서버를 <code>enable</code>, 2번 서버를 <code>disable</code> 상태로 변경한 후 <code>apply</code> 하면
다음과 같은 에러가 발생할 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">Service Unavailable - Zero size object

The server is temporarily unable to service your request. Please try again later.

Reference <span style="color:#6272a4">#15.6f4bc817.1651592357.1872133</span>
</code></pre></div><p>2번 서버로 갔던 패킷이 갑자기 유실되면 CDN에서 받는 응답 데이터가 없어서 발생하는 것으로 추측하고 있다. 🤯
<a href="https://techdocs.akamai.com/edge-diagnostics/docs/error-codes">Akamai Reference</a>에 따르면 <code>#15.x.x.x</code>는 <code>ERR_ZERO_SIZE_OBJECT</code> 에러다.</p>
<blockquote>
<p><code>ERR_ZERO_SIZE_OBJECT</code> — A response from the origin server has zero length.</p>
</blockquote>
<p>Akamai에 문의 결과 해당 페이지는 커스텀 할 수 없다고 한다.
버려지는 요청들을 어떻게 처리할지 고민이 필요하다.</p>
<h2 id="haproxy-전환">HAProxy 전환</h2>
<p>이미 부분적으로 HAProxy를 사용해서 서비스를 이중화하고 있었다.
HAProxy를 선택한 이유는 기본적으로 <a href="https://www.haproxy.com/blog/exploring-the-haproxy-stats-page/">statistics 기능이 Web UI로 제공</a>되면서
Layer 4, Layer 7 스위치로도 사용할 수 있다는 점이었다.</p>
<p><img src="/images/web/haproxy-statistics-report.png" alt="HAProxy"></p>
<p><strong>무엇보다도 마크업(Markup) 형식인 httpd 설정 파일에 비해 HAProxy의 설정 파일은 정말 간소하게 느껴졌기 때문에 전환하고 싶었다.</strong>
또한 가장 흔히 쓰는 것 같은 NGINX를 사용하지 않았던 이유는 가장 원했던 기능인
<a href="https://docs.nginx.com/nginx/admin-guide/load-balancer/http-health-check/">Active Healthcheck가 유료(NGINX Plus) 기능</a>이기 때문이다.</p>
<h2 id="선언형-배포-gitops">선언형 배포 (GitOps?)</h2>
<p>Bamboo에서는 <a href="https://confluence.atlassian.com/bamboo/bamboo-specs-894743906.html">Bamboo Specs</a>라는 명칭으로 Infrastructure as Code(IaC)를 구현한다.
— <a href="https://confluence.atlassian.com/bamboo/bamboo-yaml-specs-938844479.html">YAML Specs</a>의
설정 파일에서는 SCP, SSH 등 주요 플러그인들을 지원하지 않기 때문에
<a href="https://confluence.atlassian.com/bamboo/bamboo-java-specs-941616821.html">Java Specs</a>를 사용하는 것이 좋다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-yaml" data-lang="yaml"><span style="color:#6272a4"># Task com.atlassian.bamboo.plugins.bamboo-scp-plugin:scptask is not supported yet</span>
<span style="color:#6272a4"># Task com.atlassian.bamboo.plugins.bamboo-scp-plugin:sshtask is not supported yet</span>
</code></pre></div><p>반면 Jenkins는 사용자가 많기 때문에 비교적 많은 플러그인을 지원하며 레퍼런스도 많다.
Jenkins Pipeline을 활용하면 <code>Jenkinsfile</code> 을 사용해서 선언형 배포 방식으로 쉽게 이전할 수도 있다.
그럼 빌드-배포 과정에서 발생할 수 있는 실수를 줄일 수 있고, 설정 정보를 버전 관리할 수 있다는 장점이 있다.</p>
<p>또한 Bamboo는 Slack으로 알림을 보내기 위해서는 Instant Message(IM) 서버가 필요하다.
반면 Jenkins는 Slack 연동 플러그인만 설치하면 쉽게 알림을 보낼 수 있다.
그럼 배포 작업은 단 1단계로 줄어든다.
— 다만 기존에는 반영 사항을 공유할 때 Bamboo와 연동되어 있는 Jira 이슈만 간단히 캡처하면 됐지만,
아직 Jenkins와 Jira를 연동하지 못해서 어떻게 공유해야 할지 고민이 필요하다.</p>
<h1 id="더-읽을-거리">더 읽을 거리</h1>
<ul>
<li>CI/CD
<ul>
<li><a href="https://github.com/xpdojo/docs/blob/da871cd8fc4e59736a5f5ab5a44908534505b29f/reference/agile/ci-cd.md">CI/CD 정리</a> - markruler</li>
<li><a href="https://github.com/xpdojo/docs/blob/da871cd8fc4e59736a5f5ab5a44908534505b29f/reference/agile/continuous-integration.md">&lt;지속적인 통합&gt; 요약</a> - markruler</li>
<li><a href="https://blog.banksalad.com/tech/become-an-organization-that-deploys-1000-times-a-day/">하루에 1000번 배포하는 조직 되기</a> - Banksalad</li>
<li><a href="https://tech.kakaoenterprise.com/113">Release Note 톺아보기</a> - kakao enterprise</li>
</ul>
</li>
<li>Proxy Server
<ul>
<li><a href="https://www.lesstif.com/system-admin/forward-proxy-reverse-proxy-21430345.html">포워드 프록시(forward proxy) 리버스 프록시(reverse proxy)의 차이</a> - lesstif
<ul>
<li><a href="https://www.cloudflare.com/learning/cdn/glossary/reverse-proxy/">Proxy servers explained</a> - Cloudflare</li>
<li><a href="https://oxylabs.io/blog/reverse-proxy-vs-forward-proxy">Reverse Proxy vs. Forward Proxy: The Differences</a> - Oxylabs</li>
</ul>
</li>
</ul>
</li>
<li>SLB: Server Load Balancing
<ul>
<li><a href="https://www.nginx.com/resources/glossary/layer-7-load-balancing/">Differences Between Layer 4 and Layer 7 Load Balancing</a> - NGINX
<ul>
<li><a href="https://blog.cloudflare.com/high-availability-load-balancers-with-maglev/">High Availability Load Balancers with Maglev</a> - Cloudflare</li>
<li><a href="https://vincent.bernat.ch/en/blog/2018-multi-tier-loadbalancer">Multi-tier load-balancing with Linux</a> - Vincent Bernat</li>
<li><a href="https://blog.cloudflare.com/a-primer-on-proxies/">A Primer on Proxies</a> - Cloudflare</li>
<li><a href="https://levelup.gitconnected.com/l4-vs-l7-load-balancing-d2012e271f56">L4 vs L7 Load Balancing</a> - Mohak Puri</li>
<li><a href="https://www.nowwatersblog.com/backend/serverLoad/L4L7">L4 &amp; L7</a> - nowwater</li>
</ul>
</li>
<li>&lt;인프라/네트워크 엔지니어를 위한 네트워크 이해 및 설계 가이드&gt; - 미야타 히로시</li>
<li>&lt;인프라 엔지니어의 교과서: 네트워크 관리편&gt; - 기술평론사 엮음</li>
<li>&lt;웹 엔지니어가 알아야 할 인프라의 기본&gt; - 바바 토시아키</li>
<li><a href="https://tech.kakao.com/2014/05/30/l4/">L4 장비의 동작과 서비스 배포시 유의점</a> - Kakao</li>
<li><a href="https://elky84.github.io/2018/08/19/network_issue/">L4 스위치 도입시 생겼던 이야기</a> - elky84</li>
<li><a href="https://meetup.toast.com/posts/189">Safe Deploy - 안전하게 L4 에서 제외하는 방법</a> - NHN</li>
<li><a href="https://d2.naver.com/helloworld/284659">L4/L7 스위치의 대안, 오픈 소스 로드 밸런서 HAProxy</a> - NAVER D2</li>
</ul>
</li>
<li>Docker
<ul>
<li><a href="https://subicura.com/2016/06/07/zero-downtime-docker-deployment.html">도커를 이용한 웹서비스 무중단 배포하기</a> - subicura</li>
<li><a href="https://straz.to/2021-09-08-docker-address-pools/">The definitive guide to docker&rsquo;s default-address-pools option</a></li>
</ul>
</li>
</ul>
<h2 id="각주">각주</h2>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>&lt;AWS 토폴로지로 이해하는 Amazon VPC&gt; 10장. 분산 제어 - 차정도&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

            
            
            
            
          </div>
        </div>


        <nav class="post-pagination">
          
          <a class="newer-posts">
            다음 글<br>없음
          </a>
          

          
          <a class="older-posts" href="https://markruler.github.io/posts/java/jvm-monitoring/">
            이전 글<br>JVM 모니터링
          </a>
          
        </nav>
        
        <div class="post-comment-wrapper">
          
          







        </div>

        
        





<section class="social-share">
  <ul class="share-icons">
    
    
    <li>
      <a href="https://twitter.com/intent/tweet?hashtags=markruler,dev&amp;url=https%3a%2f%2fmarkruler.github.io%2fposts%2fci%2fci-with-lb%2f&amp;text=Load%20Balancer%eb%a5%bc%20%ed%99%9c%ec%9a%a9%ed%95%b4%ec%84%9c%20%eb%b0%b0%ed%8f%ac%20%ed%94%84%eb%a1%9c%ec%84%b8%ec%8a%a4%eb%a5%bc%20%ea%b0%9c%ec%84%a0%ed%95%b4%eb%b3%b4%ec%9e%90" target="_blank" rel="noopener" aria-label="Share on Twitter" class="share-btn twitter">
        
<svg xmlns:xlink="http://www.w3.org/1999/xlink" id="twitter" viewBox="0 0 48 48" overflow="hidden">
  <defs></defs>
  <g style="pointer-events:all">
    <title style="pointer-events:inherit">bg</title>
    <circle cx="24" cy="24" fill="#1CB7EB" r="24" style="pointer-events:inherit" id="svg_1"></circle>
    <path d="M36.8,15.4C35.9,15.9 34.8,16.2 33.8,16.3C34.9,15.6 35.7,14.5 36.1,13.2C35.1,13.8 34,14.3 32.7,14.6C31.7,13.5 30.4,12.8 28.9,12.8C26,12.8 23.6,15.3 23.6,18.5C23.6,18.9 23.6,19.4 23.7,19.8C19.3,19.6 15.4,17.3 12.8,13.9C12.3,14.7 12.1,15.7 12.1,16.8C12.1,18.8 13,20.5 14.4,21.5C13.5,21.5 12.7,21.2 12,20.8C12,20.8 12,20.9 12,20.9C12,23.6 13.8,25.9 16.2,26.5C15.8,26.6 15.3,26.7 14.8,26.7C14.5,26.7 14.1,26.7 13.8,26.6C14.5,28.9 16.4,30.5 18.7,30.5C16.9,32 14.6,32.9 12.2,32.9C11.8,32.9 11.4,32.9 10.9,32.8C13.2,34.4 16,35.4 19,35.4C28.7,35.4 34,26.8 34,19.3C34,19.1 34,18.8 34,18.6C35.2,17.6 36.1,16.6 36.8,15.4z" fill="#FFFFFF" style="pointer-events:inherit" id="svg_4"></path>
  </g>
</svg>
        <p>Twitter</p>
      </a>
    </li>
    

    
    
    <li>
      <a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fmarkruler.github.io%2fposts%2fci%2fci-with-lb%2f" target="_blank" rel="noopener" aria-label="Share on Facebook" class="share-btn facebook">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" enable-background="new 0 0 48 48" id="facebook" version="1.1" viewBox="0 0 48 48" xml:space="preserve">
  <circle cx="24" cy="24" fill="#4E71A8" r="24" />
  <path d="M29.9,19.5h-4v-2.6c0-1,0.7-1.2,1.1-1.2c0.5,0,2.8,0,2.8,0v-4.4l-3.9,0c-4.4,0-5.3,3.3-5.3,5.3v2.9h-2.5V24  h2.5c0,5.8,0,12.7,0,12.7h5.3c0,0,0-7,0-12.7h3.6L29.9,19.5z" fill="#FFFFFF" />
</svg>
        <p>Facebook</p>
        </a>
    </li>
    

    
    
    <li>
      <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fmarkruler.github.io%2fposts%2fci%2fci-with-lb%2f&amp;source=https%3a%2f%2fmarkruler.github.io%2fposts%2fci%2fci-with-lb%2f&amp;title=Load%20Balancer%eb%a5%bc%20%ed%99%9c%ec%9a%a9%ed%95%b4%ec%84%9c%20%eb%b0%b0%ed%8f%ac%20%ed%94%84%eb%a1%9c%ec%84%b8%ec%8a%a4%eb%a5%bc%20%ea%b0%9c%ec%84%a0%ed%95%b4%eb%b3%b4%ec%9e%90&amp;summary=Load%20Balancer%eb%a5%bc%20%ed%99%9c%ec%9a%a9%ed%95%b4%ec%84%9c%20%eb%b0%b0%ed%8f%ac%20%ed%94%84%eb%a1%9c%ec%84%b8%ec%8a%a4%eb%a5%bc%20%ea%b0%9c%ec%84%a0%ed%95%b4%eb%b3%b4%ec%9e%90" target="_blank" rel="noopener" aria-label="Share on LinkedIn" class="share-btn linkedin">
        <svg xmlns:xlink="http://www.w3.org/1999/xlink" id="linkedin" viewBox="0 0 128 128" overflow="hidden">
  <defs></defs>
  <g style="pointer-events:none">
    <title style="pointer-events:inherit">background</title>
    <rect x="-1" y="-1" width="582" height="402" id="canvas_background" fill="none" style="pointer-events:inherit"></rect>
  </g>
  <g style="pointer-events:all">
    <title style="pointer-events:inherit">Layer 1</title>
    <circle cx="64" cy="64" fill="#0076B4" r="64" id="svg_2" stroke-dasharray="none"></circle>
    <path d="M44.119,95.934L29.184,95.934L29.184,47.93L44.119,47.93L44.119,95.934zM36.656,41.371C31.864,41.371 28,37.495 28,32.718C28,27.943 31.864,24.066 36.656,24.066C41.427,24.066 45.302,27.942 45.302,32.718C45.303,37.495 41.428,41.371 36.656,41.371zM100,95.934L85.081,95.934L85.081,72.59C85.081,67.024 84.984,59.862 77.329,59.862C69.564,59.862 68.381,65.927 68.381,72.192L68.381,95.934L53.479,95.934L53.479,47.93L67.78,47.93L67.78,54.492L67.984,54.492C69.974,50.718 74.841,46.739 82.101,46.739C97.206,46.739 99.998,56.678 99.998,69.607L100,95.934L100,95.934z" fill="#FFFFFF" style="pointer-events:inherit" id="svg_4"></path>
  </g>
</svg>
          <p>LinkedIn</p>
        </a>
    </li>
    

    
    

    
    
    <li>
      <a href="mailto:?subject= - Load%20Balancer%eb%a5%bc%20%ed%99%9c%ec%9a%a9%ed%95%b4%ec%84%9c%20%eb%b0%b0%ed%8f%ac%20%ed%94%84%eb%a1%9c%ec%84%b8%ec%8a%a4%eb%a5%bc%20%ea%b0%9c%ec%84%a0%ed%95%b4%eb%b3%b4%ec%9e%90.&amp;body=Load%20Balancer%eb%a5%bc%20%ed%99%9c%ec%9a%a9%ed%95%b4%ec%84%9c%20%eb%b0%b0%ed%8f%ac%20%ed%94%84%eb%a1%9c%ec%84%b8%ec%8a%a4%eb%a5%bc%20%ea%b0%9c%ec%84%a0%ed%95%b4%eb%b3%b4%ec%9e%90%2c%20by%20%0a%ec%97%85%eb%ac%b4%20%ec%9e%90%eb%8f%99%ed%99%94%0a%0ahttps%3a%2f%2fmarkruler.github.io%2fposts%2fci%2fci-with-lb%2f%0a" target="_blank" class="share-btn email">
        <svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" id="email" overflow="hidden">
  <defs></defs>
  <g style="pointer-events:none">
    <title style="pointer-events:inherit">background</title>
    <rect x="-1" y="-1" width="582" height="402" id="canvas_background" fill="none" style="pointer-events:inherit"></rect>
  </g>
  <g style="pointer-events:all">
    <title style="pointer-events:inherit">Layer 1</title>
    <path d="M16,0C7.163,0 0,7.163 0,16C0,24.836 7.163,32 16,32S32,24.836 32,16C32,7.163 24.837,0 16,0z" fill="#333333" style="pointer-events:inherit" id="svg_2"></path>
    <polygon fill="#FFFFFF" points="6.518,21.815 11.707,15.291 6.518,12.119   " style="pointer-events:inherit" id="svg_4"></polygon>
    <polygon fill="#FFFFFF" points="19.5,15.746 15.989,17.908 12.472,15.758 7.11,22.5 24.867,22.5   " style="pointer-events:inherit" id="svg_5"></polygon>
    <polygon fill="#FFFFFF" points="15.988,16.864 25.482,11.017 25.482,9.5 6.518,9.5 6.518,11.076   " style="pointer-events:inherit" id="svg_6"></polygon>
    <polygon fill="#FFFFFF" points="20.263,15.276 25.482,21.843 25.482,12.062   " style="pointer-events:inherit" id="svg_7"></polygon>
  </g>
</svg>
        <p>Email</p>
      </a>
    </li>
  </ul>
</section>


      </div>
    </div>
  </div>
  
    </div><div id="single-column-footer">


&copy;
	
	Im Changsu 2020 - 2022
	
</div>
  </div>
  <script>
let app;

app = new Vue({
    el: '#app',
    data: {
        scrollY: 0,
        navOpacity: 0,
        isDrawerOpen: false,
        mounted: false,
        isDarkMode: false
    },
    methods: {
            sgn(t, x) {
                let k = 1. / (1. - 2 * t);
                if (x <= t) return 0;
                else if (x >= 1 - t) return 1;
                else {
                    return k * (x - t);
                }
            },
            handleScroll() {
                this.scrollY = window.scrollY;
                this.navOpacity = this.sgn(.0, Math.min(1, Math.max(0, window.scrollY / (this.pageHeadHeight() - this.navBarHeight() * 0.8))));
                const {navBar, navBackground, navTitle, extraContainer, streamContainer} = this.$refs;

                if (this.navOpacity >= 1) {
                    navBackground.style.opacity = 1;
                    navTitle.style.opacity = 1;
                } else {
                    navBackground.style.opacity = 0;
                    navTitle.style.opacity = 0;
                }
            },
            handleResize() {
                const {navBar, navBackground, navTitle, extraContainer, streamContainer} = this.$refs;
                extraContainer.style.left = (streamContainer.offsetWidth - extraContainer.offsetWidth) + 'px';
            },
            navBarHeight() {
                return this.$refs.navBar.offsetHeight;
            },
            pageHeadHeight() {
                return this.$refs.pageHead.offsetHeight;
            },
            toggleDrawer() {
                this.isDrawerOpen = !this.isDrawerOpen;
                document.getElementsByTagName('html')[0].style.overflow = this.isDrawerOpen ? 'hidden' : 'unset';
            },
            closeDrawer() {
                this.isDrawerOpen = false;
                document.getElementsByTagName('html')[0].style.overflow = this.isDrawerOpen ? 'hidden' : 'unset';
            },
            toggleDarkMode() {
                this.isDarkMode = !this.isDarkMode;
                if (this.isDarkMode==true){
                    document.cookie = "night=1;path=/";
                    document.body.classList.add("night");
                } else {
                    document.cookie = "night=0;path=/";
                    document.body.classList.remove("night");
                }
            }
    },
    created() {
        window.addEventListener('scroll', this.handleScroll);
        window.addEventListener('resize', this.handleResize);
        window._nonDesktop = function () {
            let check = false;
            (function (a) {
                if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true;
            })(navigator.userAgent || navigator.vendor || window.opera);
            return check;
        };
        
        var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1");
        if (night==""){
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                
                this.toggleDarkMode();
                
            }
        }else{
            
            if (night=="1") {
                this.toggleDarkMode();
            }
        }
    },
    mounted() {
        this.handleScroll();
        this.handleResize();
        this.mounted = true;

        
    },
    destroyed() {
        window.removeEventListener('scroll', this.handleScroll);
        window.removeEventListener('resize', this.handleResize);
    }
});
</script>

<script src="https://markruler.github.io//js/journal.js"></script>
</body>

</html>